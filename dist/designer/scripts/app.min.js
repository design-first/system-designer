/*
* System Designer
* https://system-designer.github.io
* @ecarriou
*
* Copyright 2016 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
"undefined"!=typeof global&&(global.require=require);var messages=[],lastPage="index.html";runtime.on("ready",function(){var a=runtime.system("app-designer-testing");a.on("main",function(){function a(){var a={},b=[];return b=document.location.href.split("?"),b.length>1&&(b=b[1].split("&"),b.forEach(function(b){var c="",d="";c=b.split("=")[0].trim(),d=b.split("=")[1].trim(),a[c]=decodeURIComponent(d)})),a}var b=null,c=null,d="",e="",f="";"undefined"!=typeof cordova&&(f=a(),e=null,Object.keys(f).length&&(e=JSON.parse(f.system),this.require("storage").set(e._id,e),lastPage=f.ref)),d=document.location.href.split("#")[1].split("?")[0],e=this.require("storage").get(d),delete e.classInfo,b=this.require("RuntimeChannel"),c=new b({_id:"channel",_core:!0}),c.on("send",function(a){this.require("designer");"undefined"!=typeof cordova&&messages.push(a),this.require("storage").set("system-designer-message",a)},!0,!0),c.on("$designerCreateSchema",function(a,b){this.require("logger").level("warn"),this.require("metamodel").schema(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$editorUpdateSchema",function(a,b){this.require("logger").level("warn"),this.require("metamodel").schema(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerDeleteSchema",function(a){this.require("logger").level("warn");var b=$db.RuntimeSchema.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeSchema.remove({_id:a}),b=$db.RuntimeModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeModel.remove({_id:d}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create()),this.require("logger").level("debug")},!0,!0),c.on("$designerCreateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$editorUpdateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerUpdateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerDeleteModel",function(a){this.require("logger").level("warn");var b=$db.RuntimeModel.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeModel.remove({_id:a}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerCreateType",function(a,b){this.require("logger").level("warn"),this.require("metamodel").type(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$editorUpdateType",function(a,b){this.require("logger").level("warn"),this.require("metamodel").type(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$editorDeleteType",function(a){this.require("logger").level("warn"),$db.RuntimeType.remove({name:a}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerDeleteType",function(a){this.require("logger").level("warn"),$db.RuntimeType.remove({name:a}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),c.on("$designerCreateComponent",function(a,b){$db[a].insert(b)},!0,!0),c.on("$editorUpdateComponent",function(a,b,c){$db[b].update({_id:a},c,{upsert:!0})},!0,!0),c.on("$designerUpdateComponent",function(a,b,c){$db[b].update({_id:a},c,{upsert:!0})},!0,!0),c.on("$editorDeleteComponent",function(a,b){$db[b].remove({_id:a})},!0,!0),c.on("$designerDeleteComponent",function(a,b){$db[b].remove({_id:a})},!0,!0),c.on("$designerCreateBehavior",function(a){$db.RuntimeBehavior.insert(a)},!0,!0),c.on("$editorUpdateBehavior",function(a,b){this.require(a)&&(this.require(a).action(b.action),"main"===b.state&&this.require(b.component).main())},!0,!0),c.on("$designerUpdateBehavior",function(a,b){this.require(a)&&(this.require(a).action(b.action),"main"===b.state&&this.require(b.component).main())},!0,!0),c.on("$editorDeleteBehavior",function(a){$db.RuntimeBehavior.remove({_id:a})},!0,!0),c.on("$designerDeleteBehavior",function(a){$db.RuntimeBehavior.remove({_id:a})},!0,!0),c.on("$designerSync",function(){this.$appLoadSystem(JSON.parse(this.require("db").system()))},!0,!0),this.require("storage").on("changed",function(a){"undefined"!=typeof a["system-designer-message"]&&$db.RuntimeMessage.insert(a["system-designer-message"].newValue)},!0,!0),this.require("logger").on("warn",function(a){if("info"===this.level()||"warn"===this.level()||"debug"===this.level()){var b=new Date,c=b.toTimeString();c=c.split(" ")[0].trim(),this.require("channel").$appLogWarn("["+c+"] "+a)}},!0,!0),this.require("logger").on("error",function(a){var b=new Date,c=b.toTimeString();c=c.split(" ")[0].trim(),this.require("channel").$appLogError("["+c+"] "+a)},!0,!0),this.require("logger").info("loading the system...");var g=this.require("db").system(e);this.require("logger").info("the system is loaded"),document.title=e.name,this.require("logger").on("debug",function(a){if("debug"===this.level()){var b=new Date,c=b.toTimeString();c=c.split(" ")[0].trim(),this.require("channel").$appLogDebug("["+c+"] "+a)}},!0,!0),this.require("logger").on("info",function(a){if("info"===this.level()||"debug"===this.level()){var b=new Date,c=b.toTimeString();c=c.split(" ")[0].trim(),this.require("channel").$appLogInfo("["+c+"] "+a)}},!0,!0),this.require("logger").level("debug"),this.require(g).main()},!0,!0),a.main()},!0,!0);