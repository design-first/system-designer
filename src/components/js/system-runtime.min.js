/*
 * System Runtime
 * 
 * https://designfirst.io/systemruntime/
 * 
 * Copyright 2017 Erwan Carriou
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).runtime=e()}}(function(){return function e(n,t,r){function i(o,s){if(!t[o]){if(!n[o]){var d="function"==typeof require&&require;if(!s&&d)return d(o,!0);if(a)return a(o,!0);var m=new Error("Cannot find module '"+o+"'");throw m.code="MODULE_NOT_FOUND",m}var l=t[o]={exports:{}};n[o][0].call(l.exports,function(e){var t=n[o][1][e];return i(t||e)},l,l.exports,e,n,t,r)}return t[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,n,t){"use strict";var r={models:{"138a81fa1f16435":{_id:"138a81fa1f16435",_name:"RuntimeAdmin",_inherit:["RuntimeComponent"],_core:!0,start:{},designerWindow:{type:"object",readOnly:!1,mandatory:!1,default:null}},"135c71078810af2":{_id:"135c71078810af2",_name:"RuntimeChannel",_inherit:["RuntimeComponent"],_core:!0,$editorUpdateSchemaName:{params:[{name:"name",type:"string"},{name:"id",type:"string"}]},$designerSync:{},$appLoadSystem:{params:[{name:"system",type:"object"}]},$designerCreateBehavior:{params:[{name:"behavior",type:"object"}]},$editorUpdateBehavior:{params:[{name:"id",type:"string"},{name:"behavior",type:"object"}]},$designerUpdateBehavior:{params:[{name:"id",type:"string"},{name:"behavior",type:"object"}]},$editorDeleteBehavior:{params:[{name:"id",type:"string"}]},$designerDeleteBehavior:{params:[{name:"id",type:"string"}]},$designerCreateComponent:{params:[{name:"collection",type:"string"},{name:"component",type:"object"}]},$editorUpdateComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"},{name:"component",type:"object"}]},$designerUpdateComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"},{name:"component",type:"object"}]},$editorDeleteComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"}]},$designerDeleteComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"}]},$designerCreateType:{params:[{name:"id",type:"string"},{name:"type",type:"object"}]},$editorUpdateType:{params:[{name:"id",type:"string"},{name:"type",type:"object"}]},$editorDeleteType:{params:[{name:"id",type:"string"}]},$designerCreateSchema:{params:[{name:"id",type:"string"},{name:"schema",type:"object"}]},$editorUpdateSchema:{params:[{name:"id",type:"string"},{name:"schema",type:"object"}]},$editorUpdateSchemaId:{params:[{name:"oldId",type:"string"},{name:"newId",type:"string"}]},$designerDeleteSchema:{params:[{name:"id",type:"string"}]},$designerCreateModel:{params:[{name:"id",type:"string"},{name:"model",type:"object"}]},$editorUpdateModel:{params:[{name:"id",type:"string"},{name:"model",type:"object"}]},$designerUpdateModel:{params:[{name:"id",type:"string"},{name:"model",type:"object"}]},$editorUpdateModelId:{params:[{name:"oldId",type:"string"},{name:"newId",type:"string"}]},$designerDeleteModel:{params:[{name:"id",type:"string"}]},$editorUpdateSystem:{params:[{name:"id",type:"string"},{name:"system",type:"object"}]},$appLogDebug:{params:[{name:"message",type:"string"}]},$appLogInfo:{params:[{name:"message",type:"string"}]},$appLogWarn:{params:[{name:"message",type:"string"}]},$appLogError:{params:[{name:"message",type:"string"}]},$runtimeCreateComponent:{params:[{name:"collection",type:"string"},{name:"component",type:"object"}]},$runtimeDeleteComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"}]},$runtimeUpdateComponent:{params:[{name:"id",type:"string"},{name:"collection",type:"string"},{name:"field",type:"string"},{name:"value",type:"any"}]},send:{params:[{name:"message",type:"message"}]},$systemInstalled:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemResolved:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemUninstalled:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemStarted:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemStopped:{params:[{name:"id",type:"string",mandatory:!0,default:""}]}},"1f4141671514c2c":{_id:"1f4141671514c2c",_name:"RuntimeStorage",get:{params:[{name:"key",type:"string",mandatory:!0,default:""}]},set:{params:[{name:"key",type:"string",mandatory:!0,default:""},{name:"value",type:"any",mandatory:!0,default:null}]},changed:{params:[{name:"changed",type:"object",mandatory:!0,default:{}}]},clear:{},remove:{params:[{name:"key",type:"string",mandatory:!0,default:""}]},_core:!0,store:{type:"object",readOnly:!1,mandatory:!1,default:{}}},"14c7c105b31a160":{_id:"14c7c105b31a160",_name:"Runtime",_core:!0,version:{type:"string",readOnly:!0,mandatory:!0,default:"0.0.0"},system:{params:[{name:"params",type:"any",mandatory:!1}],result:"object"},message:{params:[{name:"msg",type:"message",mandatory:!0}]},ready:{}},"166971fd9d107fd":{_name:"RuntimeBehavior",_core:!0,core:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},useCoreAPI:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},component:{type:"string",readOnly:!1,mandatory:!0,default:""},action:{type:"javascript",readOnly:!1,mandatory:!0,default:""},state:{type:"string",readOnly:!1,mandatory:!0,default:""},_id:"166971fd9d107fd"},"158321dced1014a":{_name:"RuntimeClassInfo",_core:!0,model:{type:"object",readOnly:!0,mandatory:!0,default:{}},property:{params:[{name:"name",type:"string"}],result:"object"},properties:{result:"array"},link:{params:[{name:"name",type:"string"}],result:"object"},links:{result:"array"},method:{params:[{name:"name",type:"string"}],result:"object"},methods:{result:"array"},collection:{params:[{name:"name",type:"string"}],result:"object"},collections:{result:"array"},event:{params:[{name:"name",type:"string"}],result:"object"},events:{result:"array"},_id:"158321dced1014a",schema:{type:"object",readOnly:!0,mandatory:!0,default:{}}},"123751cb591de26":{_id:"123751cb591de26",_name:"RuntimeComponent",_core:!0,on:{params:[{name:"state",type:"string"},{name:"handler",type:"function"},{name:"useCoreAPI",type:"boolean",mandatory:!1,default:!1},{name:"isCore",type:"boolean",mandatory:!1,default:!1}]},off:{params:[{name:"state",type:"string",mandatory:!1},{name:"behaviorId",type:"string",mandatory:!1}]},require:{params:[{name:"id",type:"string"}]},destroy:{params:[]},classInfo:{type:"@RuntimeClassInfo",readOnly:!1,mandatory:!1,default:{}},init:{params:[{name:"conf",type:"object"}]},error:{params:[{name:"data",type:"errorParam"}]}},"18a51169d7112d4":{_name:"RuntimeDatabase",_core:!0,system:{params:[{name:"system",type:"object",mandatory:!1}],result:"string"},subsystem:{params:[{name:"params",type:"object"}],result:"string"},collections:{result:"object"},insert:{params:[{name:"event",type:"dbInsertEvent"}]},update:{params:[{name:"event",type:"dbUpdateEvent"}]},remove:{params:[{name:"event",type:"dbRemoveEvent"}]},_id:"18a51169d7112d4"},"16b9d1ac2216ffe":{_id:"16b9d1ac2216ffe",_name:"RuntimeLogger",_core:!0,level:{type:"log",readOnly:!1,mandatory:!1,default:"warn"},debug:{params:[{name:"message",type:"any"}]},info:{params:[{name:"message",type:"any"}]},warn:{params:[{name:"message",type:"any"}]},error:{params:[{name:"message",type:"any"}]}},"1d9b6139411aa91":{_name:"RuntimeMessage",_core:!0,event:{type:"string",readOnly:!1,mandatory:!0,default:""},from:{type:"string",readOnly:!1,mandatory:!0,default:""},data:{type:"array",readOnly:!1,mandatory:!0,default:[]},_id:"1d9b6139411aa91"},"1628c13c22152e6":{_name:"RuntimeMetamodel",_core:!0,schema:{params:[{name:"schema",type:"object"}],result:"any"},model:{params:[{name:"model",type:"object"}],result:"any"},type:{params:[{name:"type",type:"object"}],result:"any"},create:{params:[]},_id:"1628c13c22152e6"},"177ac136891629f":{_name:"RuntimeState",_core:!0,name:{type:"string",readOnly:!1,mandatory:!0,default:""},parameters:{type:"object",readOnly:!1,mandatory:!1,default:{}},_id:"177ac136891629f"},"170521b88614387":{_name:"RuntimeSystem",_core:!0,name:{type:"string",readOnly:!1,mandatory:!0,default:""},master:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},subsystem:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},version:{type:"string",readOnly:!1,mandatory:!1,default:"0.0.1"},description:{type:"string",readOnly:!1,mandatory:!1,default:""},schemas:{type:"object",readOnly:!1,mandatory:!1,default:{}},models:{type:"object",readOnly:!1,mandatory:!1,default:{}},behaviors:{type:"object",readOnly:!1,mandatory:!1,default:{}},types:{type:"object",readOnly:!1,mandatory:!1,default:{}},components:{type:"object",readOnly:!1,mandatory:!1,default:{}},ready:{},sync:{},main:{},_id:"170521b88614387"},"100b91ed2211b15":{_id:"100b91ed2211b15",_name:"RuntimeOSGi",install:{params:[{name:"url",type:"any",mandatory:!0,default:""},{name:"async",type:"boolean",mandatory:!1,default:!0}],result:"string"},uninstall:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},start:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},stop:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},status:{result:"object"},_core:!0,bundle:{result:"string"}},"1b2811b092143f5":{_id:"1b2811b092143f5",_name:"RuntimeSystemOSGi",start:{},stop:{},_core:!0,state:{type:"string",readOnly:!1,mandatory:!1,default:"none"},location:{type:"string",readOnly:!1,mandatory:!1,default:""},uninstall:{},bundle:{result:"string"}},o1e1e01e6b41cec3:{_id:"o1e1e01e6b41cec3",_name:"RuntimeLog",action:{type:"dbAction",readOnly:!1,mandatory:!1,default:"insert"},collection:{type:"string",readOnly:!1,mandatory:!1,default:""},id:{type:"string",readOnly:!1,mandatory:!1,default:""},field:{type:"string",readOnly:!1,mandatory:!1,default:""},value:{type:"any",readOnly:!1,mandatory:!1,default:""},order:{type:"number",readOnly:!1,mandatory:!1,default:0},_core:!0}},schemas:{"10374180581a41f":{_id:"10374180581a41f",_name:"RuntimeAdmin",_inherit:["RuntimeComponent"],_core:!0,designerWindow:"property",start:"method"},"104ad1f48518376":{_id:"104ad1f48518376",_name:"RuntimeChannel",_core:!0,$editorUpdateSystem:"event",$editorUpdateSchema:"event",$editorUpdateSchemaId:"event",$editorUpdateSchemaName:"event",$editorUpdateModel:"event",$editorUpdateModelId:"event",$editorUpdateType:"event",$editorDeleteType:"event",$editorUpdateBehavior:"event",$editorDeleteBehavior:"event",$editorUpdateComponent:"event",$editorDeleteComponent:"event",$appLogDebug:"event",$appLogInfo:"event",$appLogWarn:"event",$appLogError:"event",$appLoadSystem:"event",$designerSync:"event",$designerCreateBehavior:"event",$designerCreateComponent:"event",$designerCreateType:"event",$designerCreateSchema:"event",$designerCreateModel:"event",$designerDeleteSchema:"event",$designerDeleteModel:"event",$designerDeleteType:"event",$designerDeleteBehavior:"event",$designerDeleteComponent:"event",$designerUpdateComponent:"event",$designerUpdateModel:"event",$designerUpdateBehavior:"event",$runtimeCreateComponent:"event",$runtimeDeleteComponent:"event",$runtimeUpdateComponent:"event",_inherit:["RuntimeComponent"],send:"event",$systemInstalled:"event",$systemResolved:"event",$systemStarted:"event",$systemStopped:"event",$systemUninstalled:"event"},"12fa8181ce127a0":{_id:"12fa8181ce127a0",_name:"RuntimeStorage",_inherit:["RuntimeComponent"],_core:!0,store:"property",get:"method",set:"method",remove:"method",clear:"method",changed:"event"},"12e211d4cd120a6":{_id:"12e211d4cd120a6",_name:"Runtime",_inherit:["RuntimeOSGi"],_core:!0,version:"property",system:"method",message:"method",ready:"event"},"1ac07185641fa9f":{_name:"RuntimeBehavior",_inherit:["RuntimeComponent"],_core:!0,core:"property",component:"property",action:"property",state:"property",useCoreAPI:"property",_id:"1ac07185641fa9f"},"1c00b13a1b1bc92":{_name:"RuntimeClassInfo",_inherit:["RuntimeComponent"],_core:!0,model:"property",schema:"property",method:"method",methods:"method",property:"method",properties:"method",link:"method",links:"method",collections:"method",collection:"method",event:"method",events:"method",_id:"1c00b13a1b1bc92"},"111df11e2b19fde":{_id:"111df11e2b19fde",_name:"RuntimeComponent",_inherit:[],_core:!0,classInfo:"property",on:"method",off:"method",require:"method",destroy:"method",init:"method",error:"event"},"1723516a30132ac":{_name:"RuntimeDatabase",_inherit:["RuntimeComponent"],_core:!0,system:"method",subsystem:"method",collections:"method",insert:"event",update:"event",remove:"event",_id:"1723516a30132ac"},"1268f1dddd1fea7":{_name:"RuntimeLogger",_core:!0,level:"property",debug:"method",info:"method",warn:"method",error:"method",_id:"1268f1dddd1fea7"},"14caa1c46414ee1":{_name:"RuntimeMessage",_inherit:["RuntimeComponent"],_core:!0,event:"property",from:"property",data:"property",_id:"14caa1c46414ee1"},"193f1166eb16609":{_name:"RuntimeMetamodel",_inherit:["RuntimeComponent"],_core:!0,schema:"method",model:"method",type:"method",create:"method",_id:"193f1166eb16609"},"158711d6f215e4b":{_name:"RuntimeState",_inherit:[],_core:!0,_class:!1,name:"property",parameters:"property",_id:"158711d6f215e4b"},"1cb761fa4510dca":{_id:"1cb761fa4510dca",_name:"RuntimeSystem",_inherit:["RuntimeSystemOSGi"],_core:!0,name:"property",master:"property",subsystem:"property",version:"property",description:"property",schemas:"property",models:"property",behaviors:"property",types:"property",components:"property",sync:"method",main:"method",ready:"event"},"157931f7a31b61d":{_id:"157931f7a31b61d",_name:"RuntimeOSGi",_inherit:["RuntimeComponent"],_core:!0,install:"method",uninstall:"method",start:"method",stop:"method",status:"method",bundle:"method"},"145fe10c7514298":{_id:"145fe10c7514298",_name:"RuntimeSystemOSGi",_inherit:["RuntimeComponent"],_core:!0,state:"property",location:"property",start:"method",stop:"method",uninstall:"method",bundle:"method"},f1a10d1067d1b23a:{_id:"f1a10d1067d1b23a",_name:"RuntimeLog",_inherit:["RuntimeComponent"],_core:!0,action:"property",collection:"property",id:"property",field:"property",value:"property",order:"property"}},types:{collection:{name:"collection",type:"object",schema:{type:{type:["string"],mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"object",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},css:{name:"css",type:"string",core:!0},date:{name:"date",type:"object",core:!0},errorParam:{name:"errorParam",type:"object",schema:{message:{type:"string",mandatory:!0},error:{type:"object",mandatory:!0}},core:!0},event:{name:"event",type:"object",schema:{params:{type:["parameter"],mandatory:!1},description:{type:"string",mandatory:!1}},core:!0},html:{name:"html",type:"string",core:!0},javascript:{name:"javascript",type:"string",core:!0},json:{name:"json",type:"object",core:!0},link:{name:"link",type:"object",schema:{type:{type:"string",mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"@type",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},log:{name:"log",type:"string",value:["debug","info","warn","error"],core:!0},message:{name:"message",type:"object",schema:{event:{type:"string",mandatory:!0},from:{type:"string",mandatory:!1},data:{type:"object",mandatory:!0}},core:!0},method:{name:"method",type:"object",schema:{result:{type:"string",mandatory:!1},params:{type:["parameter"],mandatory:!1},description:{type:"string",mandatory:!1}},core:!0},parameter:{name:"parameter",type:"object",schema:{name:{type:"string",mandatory:!0},type:{type:"string",mandatory:!0},mandatory:{type:"boolean",mandatory:!1},default:{type:"@type",mandatory:!1}},core:!0},property:{name:"property",type:"object",schema:{type:{type:"string",mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"@type",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},osgiStates:{name:"osgiStates",type:"string",value:["none","installed","resolved","starting","active","stopping","uninstalled"],core:!0},text:{name:"text",type:"string",core:!0},dbInsertEvent:{_id:"148ef1e19810e6d",core:!0,name:"dbInsertEvent",type:"object",schema:{collection:{type:"string",mandatory:!0,default:""},document:{type:"object",mandatory:!0,default:{}}}},dbRemoveEvent:{_id:"1952e1ac4213f4a",name:"dbRemoveEvent",type:"object",core:!0,schema:{collection:{type:"string",mandatory:!0,default:""},id:{type:"string",mandatory:!0,default:""}}},dbUpdateEvent:{_id:"1f5c41309711752",core:!0,name:"dbUpdateEvent",type:"object",schema:{collection:{type:"string",mandatory:!0,default:""},id:{type:"string",mandatory:!0,default:""},field:{type:"string",mandatory:!0,default:""},value:{type:"any",mandatory:!0,default:null}}},dbAction:{_id:"e1950e16f2914da9",core:!0,name:"dbAction",type:"string",value:["insert","update","remove"]}},behaviors:{"1c00c107e01c9b3":{_id:"1c00c107e01c9b3",component:"RuntimeAdmin",state:"start",action:"function start() {\n    var RuntimeChannel = null,\n        channel = null,\n        db = this.require('db');\n\n    if (!this.require('channel-admin')) {\n        RuntimeChannel = this.require('RuntimeChannel');\n        channel = new RuntimeChannel({\n            '_id': 'channel-admin',\n            '_core': true\n        });\n        \n        // for jquery compatibility in electron\n        if (typeof global !== 'undefined' && typeof window !== 'undefined') {\n            delete module;\n        }\n\n        channel.on('send', function send(message) {\n            this.require('admin').designerWindow().postMessage(JSON.stringify(message), '*');\n        }, false, true);\n\n        // schema change events\n        channel.on('$designerCreateSchema', function $designerCreateSchema(id, schema) {\n            this.require('logger').level('warn');\n            this.require('metamodel').schema(schema);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$editorUpdateSchema', function $editorUpdateSchema(id, schema) {\n            this.require('logger').level('warn');\n            this.require('metamodel').schema(schema);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$designerDeleteSchema', function $designerDeleteSchema(id) {\n            this.require('logger').level('warn');\n            var search = $db.RuntimeSchema.find({ '_id': id }),\n                modelName = '',\n                modelId = '';\n\n            if (search.length) {\n                modelName = search[0]._name;\n                $db.RuntimeSchema.remove({ '_id': id });\n\n                search = $db.RuntimeModel.find({ '_name': modelName });\n                if (search.length) {\n                    modelId = search[0]._id;\n                    $db.RuntimeModel.remove({ '_id': modelId });\n                    $component.removeFromMemory(modelName);\n                }\n\n                search = $db.RuntimeGeneratedModel.find({ '_name': modelName });\n                if (search.length) {\n                    modelId = search[0]._id;\n                    $db.RuntimeGeneratedModel.remove({ '_id': modelId });\n                    $component.removeFromMemory(modelName);\n                }\n                this.require('metamodel').create();\n            }\n            this.require('logger').level('debug');\n        }, true, true);\n\n        // model change events\n        channel.on('$designerCreateModel', function $designerCreateModel(id, model) {\n            this.require('logger').level('warn');\n            this.require('metamodel').model(model);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$editorUpdateModel', function $editorUpdateModel(id, model) {\n            this.require('logger').level('warn');\n            this.require('metamodel').model(model);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$designerUpdateModel', function $designerUpdateModel(id, model) {\n            this.require('logger').level('warn');\n            this.require('metamodel').model(model);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$designerDeleteModel', function $designerDeleteModel(id) {\n            this.require('logger').level('warn');\n            var search = $db.RuntimeModel.find({ '_id': id }),\n                modelName = '',\n                modelId = '';\n\n            if (search.length) {\n                modelName = search[0]._name;\n                $db.RuntimeModel.remove({ '_id': id });\n                $component.removeFromMemory(modelName);\n            }\n\n            search = $db.RuntimeGeneratedModel.find({ '_name': modelName });\n            if (search.length) {\n                modelId = search[0]._id;\n                $db.RuntimeGeneratedModel.remove({ '_id': modelId });\n                $component.removeFromMemory(modelName);\n            }\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        // type change events\n        channel.on('$designerCreateType', function $designerCreateType(id, type) {\n            this.require('logger').level('warn');\n            this.require('metamodel').type(type);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$editorUpdateType', function $editorUpdateType(id, type) {\n            this.require('logger').level('warn');\n            this.require('metamodel').type(type);\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n\n        }, true, true);\n\n        channel.on('$editorDeleteType', function $editorDeleteType(id) {\n            this.require('logger').level('warn');\n            $db.RuntimeType.remove({ 'name': id });\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        channel.on('$designerDeleteType', function $designerDeleteType(id) {\n            this.require('logger').level('warn');\n            $db.RuntimeType.remove({ 'name': id });\n            this.require('metamodel').create();\n            this.require('logger').level('debug');\n        }, true, true);\n\n        // component change events\n        channel.on('$designerCreateComponent', function $designerCreateComponent(model, component) {\n            $db[model].insert(component);\n        }, true, true);\n\n        channel.on('$editorUpdateComponent', function $editorUpdateComponent(id, collection, component) {\n            $db[collection].update({ '_id': id }, component, { 'upsert': true });\n        }, true, true);\n\n        channel.on('$designerUpdateComponent', function $editorUpdateComponent(id, collection, component) {\n            $db[collection].update({ '_id': id }, component, { 'upsert': true });\n        }, true, true);\n\n        channel.on('$editorDeleteComponent', function $editorDeleteComponent(id, collection) {\n            $db[collection].remove({ '_id': id });\n        }, true, true);\n\n        channel.on('$designerDeleteComponent', function $designerDeleteComponent(id, collection) {\n            $db[collection].remove({ '_id': id });\n        }, true, true);\n\n        // behavior change events\n        channel.on('$designerCreateBehavior', function createBehavior(component) {\n            $db.RuntimeBehavior.insert(component);\n        }, true, true);\n\n        channel.on('$editorUpdateBehavior', function $editorUpdateBehavior(id, behavior) {\n            if (this.require(id)) {\n                this.require(id).action(behavior.action);\n                if (behavior.state === 'main') {\n                    this.require(behavior.component).main();\n                }\n                if (behavior.state === 'start') {\n                    this.require(behavior.component).start();\n                }\n            }\n        }, true, true);\n\n        channel.on('$designerUpdateBehavior', function $designerUpdateBehavior(id, behavior) {\n            if (this.require(id)) {\n                this.require(id).action(behavior.action);\n                if (behavior.state === 'main') {\n                    this.require(behavior.component).main();\n                }\n                if (behavior.state === 'start') {\n                    this.require(behavior.component).start();\n                }\n            }\n        }, true, true);\n\n        channel.on('$editorDeleteBehavior', function $editorDeleteBehavior(id) {\n            $db.RuntimeBehavior.remove({ '_id': id });\n        }, true, true);\n\n        channel.on('$designerDeleteBehavior', function $editorDeleteBehavior(id) {\n            $db.RuntimeBehavior.remove({ '_id': id });\n        }, true, true);\n\n        // System Designer event\n        channel.on('$designerSync', function sync() {\n            var designerWindow = this.require('admin').designerWindow(),\n                system = null;\n\n            this.require('admin').designerWindow(null);\n            system = JSON.parse(this.require('db').system());\n            designerWindow = this.require('admin').designerWindow(designerWindow);\n\n            this.$appLoadSystem(system);\n        }, false, true);\n        \n        // Database insert event\n        db.on('insert', function insert(event) {\n          if (event.collection.indexOf('Runtime') !== 0) {\n            this.require('channel').$runtimeCreateComponent(event.collection, event.document);\n          }\n        });\n        \n         // Database remove event\n        db.on('remove', function remove(event) {\n          if (event.collection.indexOf('Runtime') !== 0) {\n            this.require('channel').$runtimeDeleteComponent(event.id, event.collection);\n          }\n        });\n        \n         // Database update event\n        db.on('update', function update(event) {\n          if (event.collection.indexOf('Runtime') !== 0) {\n            this.require('channel').$runtimeUpdateComponent(event.id, event.collecion, event.field, event.value);\n          }\n        });\n\n        window.addEventListener('message', function (event) {\n            var data = null;\n            try {\n                data = JSON.parse(event.data);\n                if (data &&\n                    typeof data.event !== 'undefined' &&\n                    typeof data.from !== 'undefined' &&\n                    typeof data.data !== 'undefined') {\n                    this.designerWindow(event.source);\n                    $db.RuntimeMessage.insert(data);\n                }\n            } catch (e) {\n            }\n        }.bind(this), false);\n\n        this.require('logger').info('admin is started');\n    } else {\n        this.require('logger').info('admin is already started');\n    }\n}",useCoreAPI:!0,core:!0},"1ca0f1020412d4f":{_id:"1ca0f1020412d4f",component:"RuntimeStorage",state:"get",action:"function get(key) {\n  var result = null;\n  \n  if (typeof this.store()[key]) {\n    result = this.store()[key];\n  }\n  return result;\n}",useCoreAPI:!1,core:!0},"16764100d51b5f8":{_id:"16764100d51b5f8",component:"RuntimeStorage",state:"set",action:"function set(key, value) {\n    var store = this.store(),\n        item = {};\n    \n    store[key] = value;\n    this.store(store);\n\n    item[key] = JSON.stringify(value);\n    \n    try {\n      switch (true) {\n        case typeof localStorage !== 'undefined':\n          localStorage.setItem(key, JSON.stringify(value)); \n          break;\n        default:\n          break;\n      }\n    } catch(e) {}\n}",useCoreAPI:!1,core:!0},"134b616b1016f60":{_id:"134b616b1016f60",component:"RuntimeStorage",state:"clear",action:"function clear() {\n  this.store({});\n  try {  \n    switch (true) {\n      case typeof localStorage !== 'undefined':\n        localStorage.clear(); \n        break;\n      default:\n        break;\n    }\n  }  catch(e) {}\n}",useCoreAPI:!1,core:!0},"14c7f1a8431b3d5":{_id:"14c7f1a8431b3d5",component:"RuntimeStorage",state:"init",action:"function init(conf) {\n  try {\n    switch (true) {\n      case typeof localStorage !== 'undefined':\n        // init \n        var keys = Object.keys(localStorage),\n            store = {},\n            i = 0,\n            length = 0;\n            \n        length = keys.length;    \n        for (i = 0; i < length; i++) {\n            try {\n              store[keys[i]] = JSON.parse(localStorage[keys[i]]);\n            } catch (e) {}\n        }\n        this.store(store);\n        \n        // event\n        window.addEventListener('storage', function (e) {\n          var obj = {},\n              store = this.store();\n              \n          try {\n            store[e.key] = JSON.parse(e.newValue);\n            this.store(store);\n           \n            obj[e.key] = {};\n            obj[e.key].oldValue = JSON.parse(e.oldValue);\n            obj[e.key].newValue = JSON.parse(e.newValue);\n            \n            this.changed(obj);\n          } catch (e) {}\n        }.bind(this));\n        break;\n      default:\n        break;\n    }\n  } catch (e) {}\n}",useCoreAPI:!1,core:!0},"1a4921ac7112bd4":{_id:"1a4921ac7112bd4",component:"RuntimeStorage",state:"remove",action:"function remove(key) {\n  var store = this.store();\n  \n  delete store[key];\n  this.store(store);\n  \n  try {\n    switch (true) {\n      case typeof localStorage !== 'undefined':\n        localStorage.removeItem(key); \n        break;\n      default:\n        break;\n    }\n  } catch(e) {}\n}",useCoreAPI:!1,core:!0},"13010167f313f87":{_id:"13010167f313f87",component:"Runtime",state:"system",action:"function system(params) {\n    var RuntimeSystem = null,\n    system = {},\n    systemId = '',\n    result = [],\n    conf = {};\n    \n    if (params) {\n        if (typeof params === 'string') {\n          conf.master = true;\n          conf.name = params;\n        } else {\n          conf = params;\n          conf.master = true;\n        }\n        RuntimeSystem = this.require('RuntimeSystem');\n        system = new RuntimeSystem(conf);\n        system.state('active');\n    } else {\n        result = $db.RuntimeSystem.find({\n            'master': true\n        });\n        if (result.length) {\n            systemId = result[0]._id;\n            system = $component.get(systemId);\n        }\n    }\n    return system;\n}",core:!0,useCoreAPI:!0},"155141e40312cd8":{_id:"155141e40312cd8",component:"RuntimeClassInfo",state:"collection",action:"function collection(name) {\n    var result = {};\n    if (this.schema()[name] === 'collection') {\n        result = this.model()[name];\n    } \n    \n    return result; \n}",core:!0},"1f6941a0c012c1f":{_id:"1f6941a0c012c1f",component:"RuntimeClassInfo",state:"collections",action:"function collections(name) {\n    var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = 0;\n    \n    length = keys.length; \n    \n    for (i = 0; i < length; i++) { \n        item = keys[i]; \n        if (this.schema()[item] === 'collection') {\n            result.push(item);\n        }\n    }\n    \n    return result;\n}",core:!0},"1ef711b4171c849":{_id:"1ef711b4171c849",component:"RuntimeClassInfo",state:"event",action:"function event(name) {\n    var result = {};\n    \n    if (this.schema()[name] === 'event') {\n        result = this.model()[name];\n    } \n    \n    return result;\n}",core:!0},"1bae51b6ed1d25c":{_id:"1bae51b6ed1d25c",component:"RuntimeClassInfo",state:"events",action:"function events(name) {\n    var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = 0;\n    \n    length = keys.length;\n    \n    for (i = 0; i < length; i++) {\n        item = keys[i];\n        if (this.schema()[item] === 'event') {\n            result.push(item);\n        }\n    } \n    return result;\n}",core:!0},"19ac2125221528b":{_id:"19ac2125221528b",component:"RuntimeClassInfo",state:"link",action:"function link(name) {\n    var result = {};\n    \n    if (this.schema()[name] === 'link') {\n        result = this.model()[name];\n    }\n    return result;\n}",core:!0},"17ed21dfc01b8e8":{_id:"17ed21dfc01b8e8",component:"RuntimeClassInfo",state:"links",action:"function links(name) { \n    var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = 0;\n    length = keys.length;\n    \n    for (i = 0; i < length; i++) {\n        item = keys[i];\n        if (this.schema()[item] === 'link') {\n            result.push(item);\n        }\n    } return result;\n}",core:!0},"11ce318a561ac61":{_id:"11ce318a561ac61",component:"RuntimeClassInfo",state:"method",action:"function method(name) {\n    var result = {};\n    if (this.schema()[name] === 'method') {\n        result = this.model()[name];\n        \n    }\n    \n    return result;\n}",core:!0},"12ff2190a018046":{_id:"12ff2190a018046",component:"RuntimeClassInfo",state:"methods",action:"function methods(name) {\n    var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = 0;\n    length = keys.length;\n    for (i = 0; i < length; i++) {\n        item = keys[i];\n        if (this.schema()[item] === 'method') {\n            result.push(item);\n        }\n    } \n    \n    return result;\n}",core:!0},"1028d1681e1fd58":{_id:"1028d1681e1fd58",component:"RuntimeClassInfo",state:"properties",action:"function properties(name) { \n    var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = 0;\n    length = keys.length;\n    \n    for (i = 0; i < length; i++) {\n        item = keys[i];\n        if (this.schema()[item] === 'property') {\n            result.push(item);\n        }\n    } return result;\n}",core:!0},"18eeb10c5319368":{_id:"18eeb10c5319368",component:"RuntimeClassInfo",state:"property",action:"function property(name) {\n    var result = {};\n    \n    if (this.schema()[name] === 'property') {\n        result = this.model()[name];\n    }\n    return result;\n}",core:!0},"1ba721201114b6b":{_id:"1ba721201114b6b",component:"RuntimeComponent",state:"destroy",action:"function destroy() {\n    $component.destroy(this.id());\n}",core:!0,useCoreAPI:!0},"15486186f41a48c":{_id:"15486186f41a48c",component:"RuntimeComponent",state:"off",action:'function off(state, behaviorId) {\n    var args = [],\n    i = 0,\n    length = 0;\n    length = arguments.length;\n    \n    for (i = 0; i < length - 7; i++) {\n        args.push(arguments[i]);\n    }\n    \n    if ($workflow.checkParams({\n        "component": this, \n        "methodName": "off", \n        "args": args\n        })) {\n        \n        if (state || behaviorId) {\n            if ($metamodel.isValidState(state, this.constructor.name)) {\n                $behavior.remove({\n                    "behaviorId": behaviorId, \n                    "componentId": this.id(), \n                    "state": state\n                });\n            } else { \n                this.require(\'logger\').warn("invoke \\\'off\\\' method of component \'" + this.id() + "\' with an invalid state \'" + state + "\'"); \n            }\n        } else {\n            $behavior.remove({\n                "componentId": this.id()\n            });\n        }\n    }\n}',core:!0,useCoreAPI:!0},"1da0a17878104c3":{_id:"1da0a17878104c3",component:"RuntimeComponent",state:"require",action:"function require(id) {\n    return $component.get(id);\n}",core:!0,useCoreAPI:!0},"1a5111d17a1800c":{_id:"1a5111d17a1800c",component:"RuntimeDatabase",state:"collections",action:"function collections() {\n    var result = {},\n    collectionName = '';\n    \n    for (collectionName in $db.store) {\n        if ($db.store.hasOwnProperty(collectionName) && collectionName.indexOf('Runtime') !== 0) {\n            result[collectionName] = $db[collectionName];\n            \n        }\n    }\n    return result;\n}",core:!0,useCoreAPI:!0},"1e5bf167ca1b61e":{_id:"1e5bf167ca1b61e",component:"RuntimeDatabase",state:"subsystem",action:"function subsystem(params) {\n    return $db.subsystem(params);\n}",core:!0,useCoreAPI:!0},"15ab1112e81b1b4":{_id:"15ab1112e81b1b4",component:"RuntimeDatabase",state:"system",action:"function system(system) {\n    var result  = '';\n    \n    if (system) {\n      result = $db.system(system);\n      this.require(result).state('active');\n    } else {\n      result = $db.system();\n    }\n    return result;\n}",core:!0,useCoreAPI:!0},"1d993108fa18ef2":{_id:"1d993108fa18ef2",component:"RuntimeLogger",state:"debug",action:"function debug(message) {\n    if (this.level() === 'debug') {\n        console.log('runtime: ' + message);\n    }\n}",core:!0},"1a37a188e11fe73":{_id:"1a37a188e11fe73",component:"RuntimeLogger",state:"error",action:"function error(message) {\n    console.error('runtime: ' + message);\n}",core:!0},"1edd21e12a16534":{_id:"1edd21e12a16534",component:"RuntimeLogger",state:"info",action:"function info(message) {\n    if (this.level() === 'info' || this.level() === 'debug') {\n        console.info('runtime: ' + message);\n    }\n}",core:!0},"141f2143d3122a4":{_id:"141f2143d3122a4",component:"RuntimeLogger",state:"level",action:"function level(val) {\n    $log.level(val);\n}",core:!0,useCoreAPI:!0},"192401bab21304e":{_id:"192401bab21304e",component:"RuntimeLogger",state:"warn",action:"function warn(message) {\n    if (this.level() === 'info' || this.level() === 'warn' || this.level() === 'debug') {\n        console.warn('runtime: ' + message);\n    } \n}",core:!0},"11fc715e2f1a31e":{_id:"11fc715e2f1a31e",component:"RuntimeMetamodel",state:"create",action:"function create() {\n        $metamodel.create();\n}",core:!0,useCoreAPI:!0},"1232f1f107142cf":{_id:"1232f1f107142cf",component:"RuntimeMetamodel",state:"model",action:"function model(model) {\n    return $metamodel.model(model);\n}",core:!0,useCoreAPI:!0},"1365412f69153d2":{_id:"1365412f69153d2",component:"RuntimeMetamodel",state:"schema",action:"function schema(schema) {\n    return $metamodel.schema(schema);\n}",core:!0,useCoreAPI:!0},"194db147fe161a2":{_id:"194db147fe161a2",component:"RuntimeMetamodel",state:"type",action:"function type(type) {\n    return $metamodel.type(type);\n}",core:!0,useCoreAPI:!0},"129f71568717a22":{_id:"129f71568717a22",component:"RuntimeSystem",state:"sync",action:"function sync() {\n    var system = JSON.parse($db.system());\n    \n    this.schemas(system.schemas);\n    this.types(system.types);\n    this.behaviors(system.behaviors);\n    this.components(system.components);\n}",core:!0,useCoreAPI:!0},"1ef951f1411b895":{_id:"1ef951f1411b895",component:"RuntimeOSGi",state:"install",action:"function install(url, async) { \n  var importedSystem = null,\n      system = {},\n      systemId = '',\n      callbackLoad = null,\n      xhr = null,\n      result = '',\n      channel = $component.get('channel');\n\n  if (typeof url === 'object') {\n    importedSystem = url;\n  } else {\n    if (url.indexOf('{') === 0) {\n      importedSystem = JSON.parse(url);\n    }\n  }\n  \n  if (importedSystem) {\n    systemId = this.require('db').system(importedSystem); \n    if (systemId) {\n      system = this.require(systemId);\n      \n      if (typeof url === 'string') {\n        system.location(url);\n      }\n      system.state('installed');    \n      channel.$systemInstalled(systemId);\n      system.state('resolved');\n      channel.$systemResolved(systemId);\n      \n      result = systemId;\n    }\n  } else {   \n    if (typeof global !== 'undefined' && typeof window === 'undefined') {\n      if (url.indexOf('.json') !== -1) {\n        system = global.require(global.process.env.PWD + '/' + url);\n      } else {\n        system = global.require(url);\n      }\n      systemId = this.require('db').system(system);\n      system = this.require(systemId);\n      \n      if (typeof url === 'string') {\n        system.location(url);\n      }\n      system.state('installed');    \n      channel.$systemInstalled(systemId);\n      system.state('resolved');\n      channel.$systemResolved(systemId);\n      \n      result = systemId;\n    } else {\n      xhr = new XMLHttpRequest();\n      callbackLoad = function callbackLoad(system, url) {\n        var sysId = $db.system(system),\n            sys = $component.get(sysId),\n            channel = $component.get('channel');\n            \n        if (typeof url === 'string') {    \n          sys.location(url);    \n        }\n        sys.state('installed');    \n        channel.$systemInstalled(sysId);\n        sys.state('resolved');\n        channel.$systemResolved(sysId);\n        \n        result = sysId;\n      };\n      \n      if (async) {\n        xhr.open('GET', url, true);\n        xhr.onreadystatechange = function () {\n          if (xhr.readyState === 4) {\n            if (xhr.status === 200) {\n              callbackLoad(JSON.parse(xhr.response), url);\n            }\n          }\n        };\n        xhr.send(null);\n      } else {\n        xhr.open('GET', url, false);\n        xhr.send(null);\n        if (xhr.status === 200) {\n          callbackLoad(JSON.parse(xhr.response), url);\n        }\n      }\n    }\n  }\n  return result;\n}",useCoreAPI:!0,core:!0},"14c1517b711cb78":{_id:"14c1517b711cb78",component:"RuntimeOSGi",state:"uninstall",action:"function uninstall(id) { \n\tvar search = {},\n\t    system = null,\n\t    behaviorId = '',\n\t    collection =  '',\n\t    componentId = '',\n\t    length = 0,\n\t    i = 0,\n\t    coreComponents = ['admin', 'channel', 'db', 'logger', 'metamodel', 'runtime'];\n\t\n\tsearch = $db.RuntimeSystem.find({\n\t  '_id': id\n\t});\n\t\n\tif (search.length) {\n\t  system = search[0];\n\t  // remove behaviors\n\t  if (system.behaviors) {\n\t    for (behaviorId in system.behaviors) {\n\t      $db.RuntimeBehavior.remove({ \n\t        '_id': system.behaviors[behaviorId]._id\n\t      });\n\t    }\n\t  }\n\t  // remove components\n\t  if (system.components) {\n\t    for (collection in system.components) {\n\t      for (componentId in system.components[collection]) {\n\t        if (coreComponents.indexOf(componentId) === -1) {\n  \t        $db[collection].remove({ \n  \t          '_id': componentId\n  \t        });\n\t        }\n\t      }\n\t    }\n\t  }\n\t}\n\t\n\tthis.require(id).state('uninstalled');\n\tchannel.$systemUninstalled(id);\n}",useCoreAPI:!0,core:!0},"1cb9d103d41dd97":{_id:"1cb9d103d41dd97",component:"e89c617b6b15d24",state:"start",action:"function start() {\n  var subsystems = [],\n    systems = [],\n    system = null,\n    scripts = [],\n    script = null,\n    mode = '',\n    logLevel = 'warn',\n    i = 0,\n    length = 0;\n\n  // in a browser\n  if (typeof document !== 'undefined') {\n    systems = document.querySelectorAll('link[rel=system]');\n    length = systems.length;\n\n    // logger\n    scripts = document.querySelectorAll('script[log]');\n    if (scripts.length) {\n      logLevel = scripts[0].getAttribute('log');\n      this.require('logger').level(logLevel);\n    }\n\n    // mode\n    scripts = document.querySelectorAll('script[mode]');\n    if (scripts.length) {\n      mode = scripts[0].getAttribute('mode');\n      \n      if (mode === 'dev') {\n        document.addEventListener('dragenter', function (e) {\n          e.stopPropagation();\n          e.preventDefault();\n        }, false);\n\n        document.addEventListener('dragover', function (e) {\n          e.stopPropagation();\n          e.preventDefault();\n        }, false);\n\n        document.addEventListener('drop', function (e) {\n          e.stopPropagation();\n          e.preventDefault();\n          var files = e.dataTransfer.files;\n          var reader = new FileReader();\n          var json = '';\n          reader.onload = function (event) {\n            json += event.target.result;\n          };\n          reader.onloadend = function () {\n            var sys = JSON.parse(json);\n            runtime.install(sys);\n          };\n          reader.readAsText(files[0], 'UTF-8');\n        });\n      }\n      if (mode === 'design') {\n        this.require('admin').start();\n      }\n    }\n\n    // systems\n    for (i = 0; i < length; i++) {\n      system = systems[i];\n\n      if (system.getAttribute('async') === 'false') {\n        this.require('runtime').install(system.href, false);\n      } else {\n        this.require('runtime').install(system.href, true);\n      }\n    }\n\n    // designer (deprecated)\n    scripts = document.querySelectorAll('script[designer]');\n    if (scripts.length) {\n      this.require('admin').start();\n    }\n\n    // ready event\n    if (length === 0) {\n      this.require('runtime').ready();\n    }\n  }\n}",useCoreAPI:!0,core:!0},"105f219c6813643":{_id:"105f219c6813643",component:"RuntimeOSGi",state:"start",action:"function start(id) { \n\tvar system = this.require(id),\n\t    channel = this.require('channel');\n\t\n\tif (system.state() === 'resolved' || system.state() === 'installed') {\n  \tsystem.state('starting');\n  \tif (system.main) {\n  \t  system.main();\n  \t}\n  \tif (system.start) {\n  \t  system.start();\n  \t}\n  \tchannel.$systemStarted(id);\n  \tsystem.state('active');\n\t}\n}",useCoreAPI:!1,core:!0},"1a81a1f00d17269":{_id:"1a81a1f00d17269",component:"RuntimeOSGi",state:"stop",action:"function stop(id) { \n\tvar system = this.require(id),\n\t    channel = this.require('channel');\n\t    \n\tif (system.state() === 'active') {\n  \tsystem.state('stopping');\n  \tif (system.stop) {\n  \t  system.stop();\n  \t}\n  \tchannel.$systemStopped(id);\n  \tsystem.state('resolved');\n  \tchannel.$systemResolved(id);\n\t}\n}",useCoreAPI:!1,core:!0},"116851b602128d1":{_id:"116851b602128d1",component:"RuntimeOSGi",state:"status",action:"function status() { \n\tvar result = {},\n\t    system = null,\n\t    length = 0,\n\t    i = 0;\n\t\n\tsystems = $db.RuntimeSystem.find({});\n\t\n\tlength = systems.length;\n\tfor (i = 0; i < length; i++) {\n\t    system = systems[i];\n\t    result[system.name] = {\n\t      'id': system._id,\n\t      'state': system.state,\n\t      'name': system.name,\n\t      'version': system.version,\n\t      'location': system.location,\n\t      'master': system.master\n\t    };\n\t}\n\t\n\treturn result;\n}",useCoreAPI:!0,core:!0},"12e491859c13918":{_id:"12e491859c13918",component:"RuntimeChannel",state:"$systemStarted",action:"function $systemStarted(id) { \n  var systems = null;\n    \n  if (id !== 'e89c617b6b15d24') {\n    if (typeof document !== 'undefined') {\n      systems = document.querySelectorAll('link[rel=system]');\n         \n      if ($state.get('runtime') && $state.get('runtime').name === 'ready') {    \n      } else {\n        if (systems.length + 1 === $db.RuntimeSystem.count()) {\n          $component.get('runtime').ready();\n        }\n      }\n    }\n  }\n}",useCoreAPI:!0,core:!0},"1e9021bd4e1bc6e":{_id:"1e9021bd4e1bc6e",component:"RuntimeChannel",state:"$systemInstalled",action:"function $systemInstalled(id) {\n    var systems = null,\n        dependencies = [],\n        master = [],\n        canStart = true;\n\n    if (id !== 'e89c617b6b15d24') {\n      // if all systems are installed\n      systems = $db.RuntimeSystem.find({});\n\n      systems.forEach(function (system) {\n          var sys = this.require(system._id);\n          if (sys.state() === 'none') {\n              canStart = false;\n          }\n      }.bind(this));\n\n      // start all the systems\n      if (canStart) {\n          dependencies = $db.RuntimeSystem.find({\n              'master': false\n          });\n\n          dependencies.forEach(function (dep) {\n              var system = this.require(dep._id);\n              channel = this.require('channel');\n              \n              if (system.state() === 'resolved') {\n                system.state('starting');\n                system.start();\n                channel.$systemStarted(dep._id);\n                system.state('active');\n              }\n          }.bind(this));\n\n          master = $db.RuntimeSystem.find({\n              'master': true\n          });\n\n          master.forEach(function (dep) {\n              var system = this.require(dep._id);\n              channel = this.require('channel');\n              \n              if (system.state() === 'resolved') {\n                system.state('starting');\n                system.start();\n                channel.$systemStarted(dep._id);\n                system.state('active');\n              }\n          }.bind(this));\n      }\n  }\n}",useCoreAPI:!0,core:!0},"1cfa4145f614da8":{_id:"1cfa4145f614da8",component:"Runtime",state:"message",action:"function message(msg) { \n\t$db.RuntimeMessage.insert(msg);\n}",useCoreAPI:!0,core:!0},"182c51edc31ad97":{_id:"182c51edc31ad97",component:"RuntimeSystemOSGi",state:"uninstall",action:"function uninstall() { \n\tthis.require('runtime').uninstall(this.id());\n}",useCoreAPI:!1,core:!0},"19cf317d7217331":{_id:"19cf317d7217331",component:"RuntimeOSGi",state:"bundle",action:"function bundle() { \n\tvar result = this.require('db').system();\n\treturn result;\n}",useCoreAPI:!1,core:!0},"14b77144911ce48":{_id:"14b77144911ce48",component:"RuntimeSystemOSGi",state:"bundle",action:"function bundle() { \n\tvar result = '',\n\tsystem = [];\n\t\n\tsystems = $db.RuntimeSystem.find({\n    '_id': this.id()\n  });\n  \n  if (systems.length) {\n    result = JSON.stringify(systems[0]);\n  }\n  \n\treturn result;\n}",useCoreAPI:!0,core:!0}},components:{RuntimeAdmin:{admin:{_id:"admin",_core:!0,designerWindow:null}},RuntimeStorage:{storage:{_id:"storage",_core:!0}},Runtime:{runtime:{_id:"runtime",version:"1.9.14"}},RuntimeDatabase:{db:{_id:"db"}},RuntimeLogger:{logger:{_id:"logger",level:"warn"}},RuntimeMetamodel:{metamodel:{_id:"metamodel"}},RuntimeSystem:{},RuntimeChannel:{channel:{_id:"channel"}}},name:"system-runtime",version:"1.9.14",description:"System Runtime",_id:"e89c617b6b15d24",master:!1,subsystem:!1};t.system=r},{}],2:[function(e,n,t){"use strict";function r(e,n,t,r){var i="",a=-1,o="",s=[],d=[],m="",l="";return a=n.indexOf("{"),l=n.substring(0,a),i=l.split("(")[0].replace("function","").trim(),o=l.split("(")[1].replace(")","").trim(),(s=o.split(",")).forEach(function(e){d.push(e.trim())}),m=n.substring(a+1),m=m.substring(0,m.lastIndexOf("}")).trim(),i=i||e,""===s[0]&&(s=[]),r&&(s.push("$component"),s.push("$db"),s.push("$metamodel"),s.push("$workflow"),s.push("$behavior"),s.push("$state"),s.push("$log")),""!==s[0]?new Function("body","return function "+i+" ("+s.join(",")+") { return new Function('"+s.join("','")+"', body).apply(this, arguments) };")(m):new Function("body","return function "+i+" () { return new Function(body).apply(this, arguments) };")(m)}function i(e,n,t,i,a){var o=c.generateId(),s=t.toString();return void 0===a&&(a=!1),void 0===i&&(i=!1),t=r(n,s,a,i),u[o]=t,l.RuntimeBehavior.insert({_id:o,component:e,state:n,action:s,useCoreAPI:i,core:a}),o}function a(e){(e=e||{}).behaviorId=e.behaviorId||"",e.componentId=e.componentId||"",e.state=e.state||"",e.componentId&&(e.behaviorId?(l.RuntimeBehavior.remove({_id:e.behaviorId,component:e.componentId,state:e.state}),delete u[e.behaviorId]):(e.state?l.RuntimeBehavior.remove({component:e.componentId,state:e.state}):l.RuntimeBehavior.remove({component:e.componentId})).forEach(function(e){delete u[e]}))}function o(e){delete u[e]}function s(e,n){var t=[],i=null;return l.RuntimeBehavior.find({component:e,state:n}).forEach(function(e){void 0===(i=u[e._id])&&(i=r(e.state,e.action,e.core,e.useCoreAPI),u[e._id]=i),t.push({useCoreAPI:e.useCoreAPI,action:i})}),t}function d(){u={}}function m(e){return u[e]}var l=e("./db.js"),c=e("./helper.js"),u={};t.add=i,t.get=m,t.remove=a,t.getActions=s,t.clear=d,t.removeFromMemory=o},{"./db.js":4,"./helper.js":5}],3:[function(e,n,t){"use strict";function r(e){function n(e,n,t,r){var i=0,c=0,u=[];if(l)N.readOnlyProperty(s,d,m);else if(-1!==o.indexOf("@"))if(e&&M.inheritFrom(e.constructor.name,o.replace("@",""))){switch(!0){case"push"===n:a.push(e.id());break;case"unshift"===n:a.unshift(e.id());break;case"splice"===n:for(c=(u=a.splice(t,r,e)).length,i=0;i<c;i++)C.state({component:s,state:m,data:[B[u[i]],"remove"]})}P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),C.state({component:s,state:m,data:[e,"add"]})}else void 0!==e.id?N.invalidPropertyName(s,d,m,e.id(),o):N.invalidPropertyName(s,d,m,e,o);else if(e&&M.isValidType(e,o)){switch(!0){case"push"===n:a.push(e);break;case"unshift"===n:a.unshift(e);break;case"splice"===n:a.splice(t,r,e)}P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),C.state({component:s,state:m,data:[e,"add"]})}else N.invalidPropertyName(s,d,m,e,o);return a.length}function t(e){var n,t=null;if(l)N.readOnlyProperty(s,d,m);else if(0!==a.length){switch(!0){case"pop"===e:t=a.pop();break;case"shift"===e:t=a.shift()}P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),n=-1!==o.indexOf("@")?B[t]:t,C.state({component:s,state:m,data:[n,"remove"]})}return n}var i=[],a=[],o="",s="",d="",m="",l=!1;return e=e||{},o=e.type||"",s=e.id||"",m=e.propertyName||"",a=e.arr||[],d=e.classId||"",void 0!==e.readOnly&&(l=e.readOnly),a.forEach(function(e){-1!==o.indexOf("@")?i.push(P.getRuntime().require(e)):i.push(e)}),i.push=function(e){return n(e,"push")},i.unshift=function(e){return n(e,"unshift")},i.concat=function(t){var i=0,o=0;if(Array.isArray(t))for(o=t.length,i=0;i<o;i++)n(t[i],"push");return e.arr=a,new r(e)},i.pop=function(){return t("pop")},i.shift=function(){return t("shift")},i.sort=function(e){return a.sort(e),P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),i},i.reverse=function(){return a.reverse(),P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),i},i.splice=function(e,t,r){var i=[],l=0,c=0,u=null;if(void 0!==r)n(r,"splice",e,t);else for(i=a.splice(e,t),P.isRuntime()&&P.getRuntime().require("db").update({collection:d,id:s,field:m,value:a}),c=i.length,l=0;l<c;l++)u=-1!==o.indexOf("@")?B[i[l]]:i[l],C.state({component:s,state:m,data:[u,"remove"]});return i},i.slice=function(e,n){return a.slice(e,n)},i}function i(e,n){var t=[],r=[],i=0,a=0;if(t=M.getModel(e)[n].params)for(i=t.length,a=0;a<i;a++)r.push(t[a].name);return r}function a(e){var n=null,t=null,r=[],i=0,a=0,o=[];for(n=M.getModel(e),t=M.getSchema(n[F]),i=(r=Object.keys(t)).length,a=0;a<i;a++)t[r[a]]!==D&&t[r[a]]!==T&&t[r[a]]!==L||o.push({name:r[a],type:n[r[a]].type,readOnly:n[r[a]].readOnly});return o}function o(e){var n=null,t=null,r=[],i=0,a=0,o=[];for(n=M.getModel(e),t=M.getSchema(n[F]),i=(r=Object.keys(t)).length,a=0;a<i;a++)t[r[a]]===U&&o.push(r[a]);return o}function s(e,n){var t=null,r=null,i=null,a=[];return t=M.getModel(n),r=t[e].type,(i=M.getType(r)).schema&&Object.keys(i.schema).forEach(function(e){i.schema[e].name=e,a.push(i.schema[e])}),a}function d(e){var n=null,t=null,r=[],i=0,a=0,o=[];for(n=M.getModel(e),t=M.getSchema(n[F]),i=(r=Object.keys(t)).length,a=0;a<i;a++)t[r[a]]===E&&o.push(r[a]);return o}function m(e,n,t){var r=null,i=I.store[e][n],a=t.split("."),o=a.length,s=0;for(r=i,s=0;s<o;s++)r=r[a[s]];return r}function l(e,n,t,r){var i=null,a=I.store[e][n],o=t.split("."),s=o.length,d=0;for(i=a,d=0;d<s-1;d++)i=i[o[d]];i[o[d]]=r}function c(e){var n=function(n){var t={};"Object"!==(n=n||{}).constructor.name&&(N.invalidConctructorParameters(n,e),n={}),M.isValidObject(n,M.getModel(e),!0,!0)||N.invalidParameters(e),M.prepareObject(n,M.getModel(e)),void 0===n._id&&(n._id=P.generateId()),B[n._id]=this,t=function(){return n._id},this.id=new Function("body","return function id () { return body.call(this) };")(t),M.inheritFrom(e,"RuntimeComponent")&&(n.classInfo=e+"Info"),I.store[e][n._id]=n,I.createLog("insert",e,n._id,"",n),P.isRuntime()&&P.getRuntime().require("db")&&P.getRuntime().require("db").insert({collection:e,document:n}),Object.freeze(this),this.init&&this.init(n)};return new Function("body","return function "+e+" (config) { body.call(this,config) };")(n)}function u(e,n){var t=function(){return n};e.id=new Function("body","return function id (prop, val) { return body.call(this, prop, val) };")(t)}function p(e,n,t){a(e).forEach(function(i){function a(e,n){var t=!0;return e.forEach(function(e){M.isValidType(e,n)&&M.inheritFrom(e.constructor.name,n.replace("@",""))&&-1!==n.indexOf("@")||(t=t&&!1)}),!0}function o(e,n){var t=[];return e.forEach(function(e){if(-1!==n[0].indexOf("@"))switch(!0){case"string"==typeof e:t.push(e);break;case void 0!==e.id:t.push(e.id());break;default:t.push(null)}else t.push(e)}),t}var s={},d="",m="",l="";d=i.name,m=i.type,l=i.readOnly,Array.isArray(m)?(s=function(e,n){var i=[],s=null,c=null,u=null;if(void 0===n){if(void 0===e)return new r({id:this.id(),propertyName:d,readOnly:l,classId:t,type:m[0],arr:I.store[t][this.id()][d]});if(Array.isArray(e))a(e,m[0])?(i=I[t].find({_id:this.id()})).length&&(s=i[0],u=o(e,m[0]),C.state({component:this.id(),state:d,data:[e,"reset"]}),s[d]=u,P.isRuntime()&&P.getRuntime().require("db").update({collection:t,id:this.id(),field:d,value:s[d]})):N.invalidPropertyName(this.id(),this.constructor.name,d,e,m);else if("number"==typeof e){if(c=I.store[t][this.id()][d][e])return u=-1!==m[0].indexOf("@")?P.getRuntime().require(c):c}else N.invalidPropertyName(this.id(),this.constructor.name,d,e,"number")}else if(l)N.readOnlyProperty(this.id(),this.constructor.name,d);else if(M.isValidType(n,m[0])||M.inheritFrom(n.constructor.name,m[0].replace("@",""))&&-1!==m[0].indexOf("@")){if((i=I[t].find({_id:this.id()})).length){if(-1!==m[0].indexOf("@"))switch(!0){case"string"==typeof n:u=n;break;case void 0!==n.id:u=n.id();break;default:u=""}else u=n;(s=i[0])[d][e]=u,P.isRuntime()&&P.getRuntime().require("db").update({collection:t,id:this.id(),field:d,value:s[d]}),C.state({component:this.id(),state:d,data:[n,"add"]})}}else N.invalidPropertyName(this.id(),this.constructor.name,d,n,m)},n.prototype[d]=new Function("body","return function "+d+" (position,value) { return body.call(this, position, value) };")(s)):(s=function(n){var r=[],i=null,a=null;if(void 0===n){if(i=I.store[t][this.id()]){switch(!0){case-1!==m.indexOf("@"):a=S(i[d]);break;case"date"===m:a=new Date(i[d]);break;case M.isStructure(d,t):a=f("",d,e,this.id());break;default:a=i[d]}return a}N.destroyedComponentCall(d,this.id())}else if(l)N.readOnlyProperty(this.id(),this.constructor.name,d);else if(M.isValidType(n,m)){if((r=I[t].find({_id:this.id()})).length){switch(i=r[0],!0){case-1!==m.indexOf("@"):i[d]=null===n?n:n.id();break;case"date"===m:i[d]="string"==typeof n?n:n.toISOString();break;default:i[d]=n}P.isRuntime()&&P.getRuntime().require("db")&&P.getRuntime().require("db").update({collection:t,id:this.id(),field:d,value:n}),"RuntimeBehavior"===t&&q.removeFromMemory(this.id()),C.state({component:this.id(),state:d,data:[n]})}}else N.invalidPropertyName(this.id(),this.constructor.name,d,n,m)},n.prototype[d]=new Function("body","return function "+d+" (value) { return body.call(this,value) };")(s))})}function f(e,n,t,r){var i={};return s(n,t).forEach(function(a){var o={},s="",d="",c="";s=a.name,d=a.type,c=a.readOnly,o=function(i){var o=[],u=null,p="",y="";if(p=e?p+"."+n:n,y=p+"."+s,void 0===i){if(I.store[t][r]){switch(!0){case-1!==d.indexOf("@"):u=S(m(t,r,y));break;case"date"===d:u=new Date(m(t,r,y));break;case M.isStructure(s,t):u=f(p,s,t,r);break;default:u=m(t,r,y)}return void 0===u&&void 0!==a.default&&(u=a.default),u}N.destroyedComponentCall(y,r)}else if(c)N.readOnlyProperty(r,t,y);else if(M.isValidType(i,d)){if((o=I[t].find({_id:r})).length){switch(o[0],!0){case-1!==d.indexOf("@"):l(t,r,y,i.id());break;case"date"===d:l(t,r,y,i.toISOString());break;default:l(t,r,y,i)}P.isRuntime()&&P.getRuntime().require("db")&&P.getRuntime().require("db").update({collection:t,id:r,field:y,value:i}),"RuntimeBehavior"===t&&q.removeFromMemory(r),C.state({component:r,state:y,data:[i]})}}else N.invalidPropertyName(r,t,y,i,d)},i[s]=new Function("body","return function "+s+" (value) { return body.call(this,value) };")(o)}),i}function y(e,n,t){o(e).forEach(function(e){var r=i(t,e).join(","),a=function(){return C.state({component:this.id(),state:e,data:arguments})};n.prototype[e]=r?new Function("body","return function "+e+" ("+r+") { return body.call(this,"+r+") };")(a):new Function("body","return function "+e+" () { return body.call(this) };")(a)})}function h(e,n,t){d(e).forEach(function(e){var r=i(t,e).join(","),a=function(){var n=[],r="e89c617b6b15d24",i=[],a=0,o=-1,s={};if("RuntimeChannel"===t){for((n=I.RuntimeSystem.find({master:!0})).length&&(r=n[0]._id),s.from=r,o=arguments.length,a=0;a<o;a++)i.push(arguments[a]);s.data=i,s.event=e,I.RuntimeMessage.insert(s),C.state({component:this.id(),state:"send",data:[{event:s.event,from:s.from,data:s.data}]})}else C.state({component:this.id(),state:e,data:arguments})};n.prototype[e]=r?new Function("body","return function "+e+" ("+r+") { return body.call(this,"+r+") };")(a):new Function("body","return function "+e+" () { return body.call(this) };")(a)})}function g(e,n){var t=function(e,t,r,i){var a="",o="";return C.checkParams({component:this,methodName:"on",args:arguments})&&(M.isValidState(e,n)?M.isEvent(e,n)||M.isProperty(e,n)||M.isLink(e,n)||M.isCollection(e,n)||!(I.RuntimeBehavior.find({component:this.id(),state:e}).length>=1)?A.validParamNumbers(n,e,t)?(a=q.add(this.id(),e,t,r,i),(o=x.get(this.id()))&&e===o.name&&C.action(a,o.parameters.data)):N.invalidParamNumberMethodOn(this.id(),this.constructor.name,e):N.behaviorNotUnique(n,e):N.invalidStateOn(n,e)),a};e.prototype.on=new Function("body","return function on (state,handler,useCoreAPI,isCore) { return body.call(this,state,handler,useCoreAPI,isCore) };")(t)}function v(e,n){var t=function(e,t,r,i){var a="",o="";return C.checkParams({component:this,methodName:"on",args:arguments})&&(M.isValidState(e,n)?M.isEvent(e,n)||M.isProperty(e,n)||M.isLink(e,n)||M.isCollection(e,n)||!(I.RuntimeBehavior.find({component:this.id(),state:e}).length>=1)?A.validParamNumbers(n,e,t)?(a=q.add(this.id(),e,t,r,i),(o=x.get(this.id()))&&e===o.name&&C.action(a,o.parameters.data)):N.invalidParamNumberMethodOn(this.id(),this.constructor.name,e):N.behaviorNotUnique(n,e):N.invalidStateOn(n,e)),a};e.on=new Function("body","return function on (state,handler,useCoreAPI,isCore) { return body.call(this, state, handler, useCoreAPI,isCore) };")(t)}function b(e,n){var t=function(e,t){C.checkParams({component:this,methodName:"off",args:arguments})&&(M.isValidState(e,n)?q.remove({behaviorId:t,componentId:n,state:e}):N.InvalidStateOff(n,e))};e.off=new Function("body","return function off (state, behaviorId) { return body.call(this, state, behaviorId) };")(t)}function _(e){var n=function(){var e=this.id(),n=[],t=0,r=0;for(I[e]&&(n=I[e].remove()),delete B[e],q.remove({componentId:e}),r=n.length,t=0;t<r;t++)q.remove({componentId:n[t]});C.state({component:e,state:"destroy"})};e.destroy=new Function("body","return function destroy () { return body.call(this) };")(n)}function R(e){var n=function(){return S(this.id()+"Info")};e.classInfo=new Function("body","return function classInfo () { return body.call(this) };")(n)}function w(e){var n={},t="";return t=void 0===(e=e||{}).model?P.generateId():e.model,n=c(t),B[t]=n,u(n,t),p(e.model,n,t),y(e.model,n,t),h(e.model,n,t),M.inheritFrom(t,"RuntimeComponent")&&(g(n,t),v(n,t),b(n,t),_(n),R(n)),Object.freeze(n),n}function S(e){return B[e]}function k(e){return w(e)}function $(e){var n=B[e],t="";n&&(delete B[e],t=n.constructor.name,I[t].remove({_id:e}),q.remove({componentId:e}),"RuntimeBehavior"===t&&q.removeFromMemory(e))}function O(e){delete B[e]}function j(){B={}}var C=e("./workflow.js"),I=e("./db.js"),M=e("./metamodel.js"),q=e("./behavior.js"),P=e("./helper.js"),N=e("./log.js"),A=e("./workflow.js"),x=e("./state.js"),T="property",D="link",L="collection",U="method",E="event",F="_name",B={};r.prototype=new Array,t.create=k,t.get=S,t.removeFromMemory=O,t.clear=j,t.destroy=$},{"./behavior.js":2,"./db.js":4,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9,"./workflow.js":10}],4:[function(e,n,t){"use strict";function r(){return S++}function i(){var e={},n="",r="",i="",a=null,o=null,s=null,d=null,m=null,l="",c="",u=0,p=0,f="";if(e.schemas={},t.RuntimeSchema.count())for(l in b.RuntimeSchema)(s=JSON.parse(JSON.stringify(b.RuntimeSchema[l])))._core||(e.schemas[l]=s);if(e.models={},t.RuntimeModel.count())for(c in b.RuntimeModel)(d=JSON.parse(JSON.stringify(b.RuntimeModel[c])))._core||(e.models[c]=d);if(e.types={},t.RuntimeType.count())for(i in b.RuntimeType)(a=JSON.parse(JSON.stringify(b.RuntimeType[i]))).core||(e.types[a.name]=a);e.behaviors={};for(r in b.RuntimeBehavior)delete(o=JSON.parse(JSON.stringify(b.RuntimeBehavior[r]))).classInfo,o.core||(e.behaviors[r]=o);for(e.components={},u=_.length,p=0;p<u;p++)if(n=_[p],t[n].count()){m=JSON.parse(JSON.stringify(b[n]));for(f in m)delete m[f].classInfo,m[f]._core&&delete m[f];Object.keys(m).length&&(e.components[n]=m)}return e}function a(e,n){var t=!0,r=!1,i="",a=0,o=0;for(i in e){if(void 0===n[i]){t=!1;break}if(e[i]instanceof RegExp){if(Array.isArray(n[i])&&!Array.isArray(e[i])){for(o=n[i].length,a=0;a<o;a++)if(null!==n[i][a].toString().match(e[i])){r=!0;break}t=r}else if(null===n[i].toString().match(e[i])){t=!1;break}}else if(Array.isArray(n[i])&&!Array.isArray(e[i])){if(-1===n[i].indexOf(e[i])){t=!1;break}}else if(n[i]!==e[i]){t=!1;break}}return t}function o(e,n,t,i,a){var o=f.generateId();n=n||"",t=t||"",i=i||"",a=a||"",Object.keys(b.RuntimeLog).length>1e3&&(b.RuntimeLog={}),b.RuntimeLog[o]={_id:o,action:e,collection:n,id:t,field:i,value:a,order:r()}}function s(e){t[e]=new k(e)}function d(e){var n="",r="",a="",o="",s="",d="",m="",l=[],c=null,u=null,f=null,h=null,g={};if(e){for(o in e.types)p.type(e.types[o]);for(s in e.schemas)p.schema(e.schemas[s]);for(d in e.models)p.model(e.models[d]);p.create();for(m in e.behaviors)t.RuntimeBehavior.insert(e.behaviors[m]);for(r in e.components)for(a in e.components[r])t[r].insert(e.components[r][a]);(l=t.RuntimeSystem.find({master:!0})).length&&(l[0]._id===e._id?e.master=!0:(e.master=!0,l[0].master=!1)),t.RuntimeSystem.insert(e),n=e._id}else if((l=t.RuntimeSystem.find({master:!0})).length){c=(f=l[0])._id,g._id=c,g.name=f.name,g.description=f.description,g.version=f.version,g.master=!0,g.subsystem=!1,u=i();for(r in u)u.hasOwnProperty(r)&&(g[r]=u[r]);for(m in g.behaviors)"main"!==(h=g.behaviors[m]).state&&"start"!==h.state&&"stop"!==h.state||(h.component=c);n=JSON.stringify(g)}else n="{}",y.masterSystemNotFound();return n}function m(e){var n={},r=[],i="",a=0,o=0,s=null,d=null,m=null,l=null,c=null,u="";if((r=t.RuntimeSystem.find({master:!0})).length&&(i=r[0].name),n.name=e.name||"sub_"+i,n.version=e.version||"0.0.1",n.description=e.description||"",n.subsystem=!0,n.schemas={},e.schemas)for(o=(r=t.RuntimeSchema.find(e.schema)).length,a=0;a<o;a++)(s=r[a])._core||(n.schemas[s._id]=s);if(n.models={},e.models)for(o=(r=t.RuntimeModel.find(e.models)).length,a=0;a<o;a++)(m=r[a])._core||(n.models[m._id]=m);if(n.types={},e.types)for(o=(r=t.RuntimeType.find(e.types)).length,a=0;a<o;a++)(d=r[a])._core||(n.types[d._id]=d);if(n.behaviors={},e.behaviors)for(l=t.RuntimeBehavior.find(e.behaviors),o=r.length,a=0;a<o;a++)(l=r[a]).core||(n.behaviors[l._id]=l);if(n.components={},e.components)for(u in e.components)if(t[u])for(n.components[u]={},o=(r=t[u].find(e.components[u])).length,a=0;a<o;a++)c=r[a],n.components[u][c._id]=c;return JSON.stringify(n)}function l(){var e=0,n=0,r="";for(e=_.length,n=0;n<e;n++)r=_[n],t[r].remove();for(e=R.length,n=0;n<e;n++)r=R[n],t[r].remove()}function c(){var e="",n=null;n=t.RuntimeSystem.find({_id:"e89c617b6b15d24"})[0],t.clear(),u.clear(),p.clear(),g.clear(),h.clear(),p.init(),e=t.system(n),u.get(e).main()}var u=e("./component.js"),p=e("./metamodel.js"),f=e("./helper.js"),y=e("./log.js"),h=e("./behavior.js"),g=e("./state.js"),v=e("./workflow.js"),b={},_=[],R=["Runtime","RuntimeSchema","RuntimeModel","RuntimeGeneratedModel","RuntimeBehavior","RuntimeState","RuntimeType","RuntimeMetamodel","RuntimeDatabase","RuntimeSystem","RuntimeClassInfo","RuntimeMessage","RuntimeChannel","RuntimeLogger","RuntimeLog"],w=["RuntimeLog","RuntimeSchema","RuntimeLogger","RuntimeModel","RuntimeGeneratedModel","RuntimeState","RuntimeType"],S=0,k=function(e){p.getSchema(e)||-1!==R.indexOf(e)?(b[e]={},this.name=e,-1===R.indexOf(e)&&_.push(e)):y.invalidCollectionName(e)};k.prototype.find=function(e){var n=[],t={},r="",i={};if((e=e||null)&&Object.keys(e).length)if(Array.isArray(e))e.forEach(function(e){for(r in b[this.name])a(e,i=b[this.name][r])&&void 0===t[r]&&(n.push(i),t[r]=!0)}.bind(this));else for(r in b[this.name])a(e,i=b[this.name][r])&&n.push(i);else for(r in b[this.name])i=b[this.name][r],n.push(i);return n},k.prototype.insert=function(e){var n=[],r=null,i=[];return Array.isArray(e)?n=e:n.push(e),n.forEach(function(e){var n=null,a=[];switch(!0){case"RuntimeSchema"===this.name:case"RuntimeLogger"===this.name:case"RuntimeModel"===this.name:case"RuntimeType"===this.name:case"RuntimeGeneratedModel"===this.name:case p.isValidObject(e,p.getModel(this.name)):if(void 0===e._id&&(e._id=f.generateId()),p.prepareObject(e,p.getModel(this.name)),b[this.name][e._id]=e,r=u.get(this.name),r?(n=new r(e),i.push(n.id())):(o("insert",this.name,e._id,"",e),f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").insert({collection:this.name,document:e})),"RuntimeMessage"===this.name&&f.isRuntime())for(var s=(a=t.RuntimeChannel.find({})).length,d=0;d<s;d++)f.getRuntime().require(a[d]._id),v.state({component:a[d]._id,state:e.event,data:e.data});break;default:y.invalidDocumentOnDbInsert(e,this.name)}}.bind(this)),i},k.prototype.update=function(e,n,t){var r=this.find(e),i=0,a=0,s=r.length,d="",m=p.getModel(this.name),l="";if(void 0===(t=t||{}).upsert&&(t.upsert=t.upsert||!1),n)for(0===s&&t.upsert&&(e._id&&(n._id=e._id),this.insert(n),i+=1),a=0;a<s;a++){void 0!==n._id&&n._id!==r[a]._id&&y.updateUuid(r[a]._id,n._id,void 0!==u.get(n._id));for(d in n)void 0!==r[a][d]&&("RuntimeSchema"!==this.name&&"RuntimeModel"!==this.name&&"RuntimeGeneratedModel"!==this.name?(l="",0!==d.indexOf("_")?l=m[d].type:p.getMetaDef()[d]&&(l=p.getMetaDef()[d].type),l?p.isValidType(n[d],l)?(r[a][d]=n[d],i+=1,o("update",this.name,r[a]._id,d,n[d]),f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").update({collection:this.name,id:r[a]._id,field:d,value:n[d]}),v.state({component:r[a]._id,state:d,data:[n[d]]})):y.invalidPropertyTypeOnDbUpdate(this.name,r[a]._id,d,n[d],m[d].type):y.unknownPropertyOnDbUpdate(this.name,d,r[a]._id)):(r[a][d]=n[d],o("update",this.name,r[a]._id,d,n[d]),i+=1,f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").update({collection:this.name,id:r[a]._id,field:d,value:n[d]})))}return i},k.prototype.remove=function(e){var n=[],t="",r=null,i={};if((e=e||null)&&Object.keys(e).length)if(Array.isArray(e))e.forEach(function(e){for(t in b[this.name])a(e,i=b[this.name][t])&&(delete b[this.name][t],o("remove",this.name,t,"",""),(r=u.get(t))&&r.destroy(),f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").remove({collection:this.name,id:t}),n.push(t))}.bind(this));else for(t in b[this.name])a(e,i=b[this.name][t])&&(delete b[this.name][t],o("remove",this.name,t,"",""),(r=u.get(t))&&r.destroy(),f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").remove({collection:this.name,id:t}),n.push(t));else for(t in b[this.name])delete b[this.name][t],o("remove",this.name,t,"",""),-1==w.indexOf(this.name)&&(r=u.get(t))&&r.destroy(),f.isRuntime()&&f.getRuntime().require("db")&&f.getRuntime().require("db").remove({collection:this.name,id:t}),n.push(t);return n},k.prototype.count=function(){var e=0,n="";for(n in b[this.name])e++;return e},t.createLog=o,t.collection=s,t.store=b,t.system=d,t.subsystem=m,t.clear=l,t.init=c},{"./behavior.js":2,"./component.js":3,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9,"./workflow.js":10}],5:[function(e,n,t){"use strict";function r(){var e=!1;return s.Runtime&&s.Runtime.find().length&&(e=!0),e}function i(){var e="";return m||(e=s.Runtime.find()[0]._id,m=d.get(e)),m}function a(){function e(){return Math.floor(65536*(1+Math.random())).toString(16)}return function(){return"abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(Math.random()*"abcdefghijklmnopqrstuvwxyz".length))}()+e()+e()+e()}function o(){void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){var e=/function\s([^(]{1,})\(/.exec(this.toString());return e&&e.length>1?e[1].trim():""},set:function(e){}})}var s=e("./db.js"),d=e("./component.js"),m=null;t.getRuntime=i,t.isRuntime=r,t.generateId=a,t.polyfill=o},{"./component.js":3,"./db.js":4}],6:[function(e,n,t){"use strict";function r(){var e="",n=[],t=null;return oe.getModel("RuntimeLogger")&&(n=se.RuntimeLogger.find()).length?(e=n[0][me],t=de.get(e)?ue=de.get(e):pe):t=pe,t}function i(e){ce=e}function a(e,n){var t="";t=n[le]?"unknown property '"+e+"' for the definition of '"+n[le]+"'":"unknown property '"+e+"' for a model",r().warn(t)}function o(e,n,t){r().warn("invalid type for property '"+e+"': expected type '"+n+"' instead of type '"+typeof t+"'")}function s(e,n){r().warn("'"+e+"' is an invalid value for the type enum '"+n+"'")}function d(e,n,t){r().warn("invalid class name for component '"+e+"': expected '"+n+"' instead of '"+t+"'")}function m(e){r().warn("missing property '"+e+"'")}function l(e){r().warn("schema '"+e+"' is missing.")}function c(e,n){r().error("the property '"+e+"' of the model '"+n+"' is invalid")}function u(e,n){r().warn("missing property '"+e+"' for the definition of '"+n+"'")}function p(e,n){r().error("the model '"+n+"' has an unknown property '"+e+"'")}function f(e){r().warn("the type '"+e+"' is not valid")}function y(e,n,t,i,a){var o="";"Function"!==n&&(o=" (class '"+n+"')"),"string"==typeof a?r().warn("invalid type for property '"+t+"' on component '"+e+"'"+o+": expected '"+a.replace("@","")+"' instead of '"+typeof i+"'"):r().warn("invalid type for property type '"+t+"' on component '"+o+": expected 'string' instead of '"+typeof a+"'")}function h(e,n,t){var i="";"Function"!==n&&(i=" (class '"+n+"')"),r().warn("can not set read-only property '"+t+"' on component '"+e+"'"+i)}function g(e,n){r().warn("invalid document '"+JSON.stringify(e).replace(/,/g,", ")+"' on an insert operation on collection '"+n+"'")}function v(e,n,t,i,a){r().warn("invalid type when trying to update the property '"+t+"' of document '"+n+"' (collection '"+e+"') with the value '"+JSON.stringify(i)+"': expected type '"+a+"'")}function b(e,n,t){r().warn("unknown property '"+e+"' on an update operation on collection '"+n+"' with component '"+t+"'")}function _(e,n){r().warn("try to call an unknown method '"+n+"' for the class '"+e+"'")}function R(e){r().warn("invalid name for creating the collection '"+e+"': there is no schema '"+e+"' in the metamodel")}function w(e,n,t,i,a){var o="";"Function"!==n&&(o=" (class '"+n+"')"),a?r().warn("invalid type for the result of method '"+t+"' on component '"+e+"'"+o+": expected type '"+i.replace("@","")+"' instead of type '"+a+"'"):r().warn("invalid type for the result of method '"+t+"' on component '"+e+"'"+o+": expected type '"+i.replace("@","")+"'")}function S(e,n){r().warn("unkown class component '"+e+"' for component '"+n+"'")}function k(){r().warn("runtime has been restarted")}function $(e,n,t){var i="";"Function"!==n&&(i=" (class '"+n+"')"),r().warn("invalid number of parameters when calling the method '"+t+"' on component '"+e+"'"+i)}function O(e,n,t,i){var a="";"Function"!==n&&(a=" (class '"+n+"')"),void 0!==i?r().warn("invalid type for the parameter '"+i+"' when calling the method '"+t+"' on component '"+e+"'"+a):r().warn("invalid type for a parameter when calling the method '"+t+"' on component '"+e+"'"+a)}function j(e,n){r().warn("try to add more than one behavior for the state '"+n+"' on class '"+e+"'")}function C(e,n){r().warn("try to add a behavior with an unkwown state '"+n+"' on class '"+e+"'")}function I(e,n){r().warn("try to remove a behavior from an unkwown state '"+n+"' on class '"+e+"'")}function M(){r().warn("can not export the database because no system was defined")}function q(e,n){r().warn("invalid type for value '"+JSON.stringify(e)+"': expected '"+n+"'")}function P(e){r().warn("unknown type for value '"+JSON.stringify(e)+"'")}function N(e,n){r().debug("can not yet validate if the component '"+e+"' is an instance of '"+n+"'")}function A(e,n,t){r().warn("invalid type for the message '"+JSON.stringify(e)+"': expected type '"+t+"' for event '"+n+"'")}function x(e,n,t){var i="";"Function"!==n&&(i=" (class '"+n+"')"),r().warn("invalid number of parameters when adding an action on method '"+t+"' on component '"+e+"'"+i)}function T(e,n,t){t?r().warn("try to update a component of id '"+e+"' with the new id '"+n+"' that is already used"):r().warn("try to update a component of id '"+e+"' with the new id '"+n+"'")}function D(e){r().warn("try to change the state of the destroyed component '"+e+"'")}function L(e){r().warn("the schema '"+e+"' is not valid")}function U(e){r().warn("the model '"+e+"' is not valid")}function E(e){r().warn("the parameters for creating a component of class '"+e+"' are not compliant with the model")}function F(e,n){r().warn("trying to get the property '"+e+"' on the destroyed component '"+n+"'")}function B(e,n){r().warn("the constructor parameter '"+JSON.stringify(e).replace(/,/g,", ")+"' for creating a component of class '"+n+"' is not an object")}function J(e){r().warn("try get the information of an unknown model '"+e+"'")}function V(e){r().warn("the schema '"+e+"' is missing")}function G(e){e?r().error("a cyclic inheritance dependency with "+e+" schema has been found, please check the '_inherit' properties of your schemas"):r().error("a cyclic inheritance dependency has been found, please check the '_inherit' properties of your schemas")}function W(e,n,t){t!==typeof e?r().warn("invalid type for enumerated type '"+n+"': expected type '"+t+"' instead of type '"+typeof e+"'"):r().warn("invalid type for enumerated type '"+n+"'")}function z(e){r().debug("load schema '"+e+"'")}function Y(e){r().debug("load model '"+e+"'")}function H(e){r().debug("load type '"+e+"'")}function X(e){r().debug("compile schema '"+e+"'...")}function K(e){r().debug("generate model '"+e+"'...")}function Q(e){r().debug("analyze model '"+e+"'...")}function Z(e){r().debug("create collection '"+e+"'")}function ee(e){r().debug("create class '"+e+"'")}function ne(){r().debug("starting model creation...")}function te(){r().debug("model creation ended")}function re(e,n,t,i){"Function"!==t?r().error("error when trying to call the method '"+e+"' on component '"+n+"' (class '"+t+"'): "+i):r().error("error when trying to call the method '"+e+"' on component '"+n+"': "+i)}function ie(e,n){r().warn("invalid property '"+n+"' for schema '"+e+"': only 'property', 'link', 'collection', 'method' and 'event' are allowed.")}function ae(e){r().warn("invalid format for a definition of a property': '"+e+"' is not an object")}e("./helper.js"),e("./workflow.js");var oe=e("./metamodel.js"),se=e("./db.js"),de=e("./component.js"),me="_id",le="_name",ce="warn",ue=null,pe={currentLevel:"warn",level:function(e){return e&&(this.currentLevel=e),this.currentLevel},debug:function(e){"debug"===this.currentLevel&&console.log("runtime: "+e)},info:function(e){"info"!==this.currentLevel&&"debug"!==this.currentLevel||console.info("runtime: "+e)},warn:function(e){"info"!==this.currentLevel&&"warn"!==this.currentLevel&&"debug"!==this.currentLevel||console.warn("runtime: "+e)},error:function(e){console.error("runtime: "+e)}};t.level=i,t.unknownProperty=a,t.invalidPropertyType=o,t.invalidEnumValue=s,t.invalidClassName=d,t.missingProperty=m,t.missingImplementation=l,t.invalidTypeImp=c,t.missingPropertyImp=u,t.unknownPropertyImp=p,t.invalidTypeDefinition=f,t.invalidPropertyName=y,t.readOnlyProperty=h,t.invalidDocumentOnDbInsert=g,t.invalidPropertyTypeOnDbUpdate=v,t.unknownMethod=_,t.invalidCollectionName=R,t.invalidResultType=w,t.unknownComponent=S,t.workflowRestarted=k,t.invalidParamNumber=$,t.invalidParamType=O,t.behaviorNotUnique=j,t.invalidStateOn=C,t.invalidStateOff=I,t.masterSystemNotFound=M,t.invalidType=q,t.unknownType=P,t.canNotYetValidate=N,t.invalidChannelEvent=A,t.invalidParamNumberMethodOn=x,t.updateUuid=T,t.unknownPropertyOnDbUpdate=b,t.invalidUseOfComponent=D,t.invalidSchema=L,t.invalidModel=U,t.invalidParameters=E,t.destroyedComponentCall=F,t.invalidConctructorParameters=B,t.unknownModel=J,t.missingSchema=V,t.cyclicDependency=G,t.invalidEnumType=W,t.loadSchema=z,t.loadModel=Y,t.loadType=H,t.compileSchema=X,t.generateModel=K,t.checkModel=Q,t.createCollection=Z,t.createClass=ee,t.modelCreationBegin=ne,t.modelCreationEnd=te,t.actionInvokeError=re,t.invalidSchemaProperty=ie,t.invalidPropertyFormat=ae},{"./component.js":3,"./db.js":4,"./helper.js":5,"./metamodel.js":7,"./workflow.js":10}],7:[function(e,n,t){"use strict";function r(){var e="",n="",t="",r={},i="",a=null,o=null,d=null,m={},l={},c=[],u=0,p=0,f=0,y=0,h=[];for(t in fe.compiledSchemas){m={_name:(r=fe.compiledSchemas[t])._name},void 0!==r._core&&(m._core=r._core),Array.isArray(r._inherit)&&(m._inherit=r._inherit),void 0!==r._class&&(m._class=r._class),void 0!==r._description&&(m._description=r._description);for(e in r)switch(!0){case"property"===r[e]:m[e]={type:"any",readOnly:!1,mandatory:!1,default:"",description:e,label:e};break;case"link"===r[e]:m[e]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,default:"",description:e,label:e};break;case"method"===r[e]:m[e]={params:[{name:"param",type:"any",mandatory:!1}],result:"any",description:e};break;case"event"===r[e]:m[e]={params:[{name:"param",type:"any",mandatory:!1}],description:e};break;case"collection"===r[e]:m[e]={type:["@RuntimeComponent"],readOnly:!1,mandatory:!1,default:[],description:e,label:e};break;default:0!==e.indexOf("_")&&Q.invalidSchemaProperty(r._name,e)}fe.generatedModels[m._name]=m}for(i in fe.generatedModels)n=(m=fe.generatedModels[i])[te],(o=fe.models[n])&&(l=O(o,m),fe.generatedModels[n]=l);for(y=(h=s()).length,p=0;p<y;p++)if(i=h[p],m=fe.generatedModels[i]){(c=H(i)).reverse();JSON.parse(JSON.stringify(m));for(u=c.length,f=0;f<u;f++)n=c[f],(a=fe.generatedModels[n])&&(l=O(a,m),fe.generatedModels[i]=l);(o=fe.models[i])&&(l=O(o,fe.generatedModels[i]),fe.generatedModels[i]=l)}for(i in fe.generatedModels)d=fe.generatedModels[i],K.RuntimeGeneratedModel.insert(d),d._core||Q.generateModel(i)}function i(){var e=[],n=[],t=null,r={},i=[],a=null,o="",s="",d=0,m=0;for(fe.inheritance={},fe.inheritanceTree={},fe.schemas={},fe.compiledSchemas={},fe.models={},fe.generatedModels={},fe.states={},fe.type={},m=(e=K.RuntimeSchema.find({})).length,d=0;d<m;d++)o=(t=e[d])[te],s=t[ie],fe.schemas[o]=t,s&&(fe.inheritance[o]=s),t._core||Q.loadSchema(o);for(m=(i=K.RuntimeModel.find({})).length,d=0;d<m;d++)o=(r=i[d])[te],fe.models[o]=r,r._core||Q.loadModel(o);for(m=(n=K.RuntimeType.find({})).length,d=0;d<m;d++)a=n[d],fe.type[a.name]=a,a.core||Q.loadType(a.name)}function a(){function e(e){var n=0,t=0,r=!0;for(t=e.length,n=0;n<t;n++)e[n].length&&(r=!1);return r}function n(e,n){var t=0,r=0,i=[];for(r=n.length,t=0;t<r;t++)0===n[t].indexOf(e)&&((i=n[t]).reverse(),i.pop(),i.reverse(),n[t]=i)}function t(e,n){var t=!0,r=0,i=0;for(i=n.length,r=0;r<i;r++)n[r].indexOf(e)>0&&(t=!1);return t}function r(e){var r=0,i=0,a=[];for(i=e.length,r=0;r<i;r++)if(t(e[r][0],e)){a.push(e[r][0]),n(e[r][0],e);break}return a}function i(n){var t=[],i=[];for(i=r(n);void 0!==i[0];)t=t.concat(i),i=r(n);return e(n)||Q.cyclicDependency(),t}function a(e){var n=[],t=0,r=0;for(Array.isArray(fe.inheritance[e])?n=fe.inheritance[e].slice():Q.missingSchema(e),r=n.length,t=0;t<r;t++)if(function(e,n){var t=!1;return Array.isArray(fe.inheritance[n])&&-1!==fe.inheritance[n].indexOf(e)&&(Q.cyclicDependency(e),t=!0),t}(e,n[t])){n=[];break}return n.length?[e].concat(i(n.map(a).concat([n]))):[e]}var o="",s=[];for(o in fe.inheritance)(s=a(o).reverse()).pop(),s.length&&(fe.inheritanceTree[o]=s)}function o(e){var n={},t=fe.schemas[e],r=fe.inheritanceTree[e],i=0,a=0,o=null,s="";for(r&&(i=r.length,r.reverse()),a=0;a<i;a++){o=fe.schemas[r[a]];for(s in o)0!==s.indexOf("_")&&(n[s]=o[s])}for(s in t)n[s]=t[s];return n}function s(){var e=[],n={},t="",r=0;for(t in fe.inheritanceTree)r=fe.inheritanceTree[t].length,void 0===n[r]&&(n[r]=[]),n[r].push(t);return Object.keys(n).sort().forEach(function(t){n[t].forEach(function(n){e.push(n)})}),e}function d(){var e="";for(e in fe.schemas)fe.schemas[e]._core||Q.compileSchema(e),fe.compiledSchemas[e]=o(e)}function m(){var e="",n=null,t="";for(e in fe.generatedModels)(n=fe.generatedModels[e])&&((t=fe.compiledSchemas[e])?(n._core||Q.checkModel(e),c(n,t)):Q.missingImplementation(e))}function l(){var e="",n=null,t="",r=[],i="";for(e in fe.compiledSchemas){if(r=[],n=fe.compiledSchemas[e])for(i in n)t=n[i],0!==i.indexOf("_")&&-1!==ue.indexOf(t)&&r.push(i);fe.states[e]=r}}function c(e,n){var t="";for(t in n)t!==ne&&t!==te&&t!==re&&t!==ie&&t!==ae&&t!==oe&&(void 0!==e[t]?u(e[t],n[t])||Q.invalidTypeImp(t,e[te]):Q.missingPropertyImp(t,e[te]));for(t in e)t!==ne&&t!==te&&t!==re&&t!==ie&&t!==ae&&t!==oe&&void 0===n[t]&&Q.unknownPropertyImp(t,e[te])}function u(e,n){return k(n,"string")&&-1!==pe.indexOf(n)?k(e,n):p(e,n)}function p(e,n){var t=!0,r=fe.type[n],i=0,a=0;if(k(r,"undefined"))t=!1;else if(k(e,"undefined"))t=!1;else if("array"===r.type)for(i=e.length,a=0;a<i&&!1!==(t=k(r.schema,"undefined")?E(e[a],r.type):B(e[a],r.schema));a++);else t=k(r.schema,"undefined")?E(e,r.type):B(e,r.schema);return t}function f(){K.collection("RuntimeLogger"),K.collection("RuntimeSchema"),K.collection("RuntimeModel"),K.collection("RuntimeGeneratedModel"),K.collection("RuntimeClassInfo"),K.collection("RuntimeBehavior"),K.collection("RuntimeState"),K.collection("RuntimeType"),K.collection("RuntimeMessage"),K.collection("RuntimeChannel"),K.collection("RuntimeLog")}function y(){var e="",n={};for(e in fe.generatedModels)n=fe.generatedModels[e],void 0===K[n[te]]&&!1!==n[ae]&&(K.collection(n[te]),n._core||Q.createCollection(n[te]))}function h(){var e="",n={};for(e in fe.generatedModels)!1!==(n=fe.generatedModels[e])[ae]&&(Z.create({model:e}),n._core||Q.createClass(e))}function g(){var e="",n={},t="";for(e in fe.generatedModels)t=(n=fe.generatedModels[e])[te]+"Info",!1!==n[ae]&&X(n[te],"RuntimeComponent")&&(Z.get(t)?K.RuntimeClassInfo.update({_id:t},{_id:t,schema:fe.compiledSchemas[e],model:n}):K.RuntimeClassInfo.insert({_id:t,schema:fe.compiledSchemas[e],model:n}))}function v(e){return e.replace("@","")}function b(e){return k(e,"string")&&-1===pe.indexOf(e)&&!_(e)}function _(e){return-1!==e.indexOf("@")}function R(e){var n="";return n=Array.isArray(e)?"array":typeof e,"any"===e&&(n="any"),n}function w(e){var n="";return e&&e.constructor&&(n=e.constructor.name),n}function S(e,n){return-1!==n.indexOf(e)}function k(e,n){var t=!0,r=null;switch(n){case"array":t=Array.isArray(e);break;case"date":"string"==typeof e?(r=new Date(e),t=!isNaN(r.getDate())):t=e instanceof Date;break;case"any":t=!0;break;default:t=n===typeof e}return t}function $(e,n,t){var r=!1,i=fe.generatedModels[n];return i&&i[te]&&(i=fe.compiledSchemas[i[te]]),i&&i[e]===t&&(r=!0),r}function O(e,n,t){var r="",i=n;for(r in e)e.hasOwnProperty(r)&&0!==r.indexOf("_")&&(i[r]=e[r]);return i}function j(e){var n=null,t=null,r="",i={},a=[];return t=JSON.parse(JSON.stringify(e)),r=t[te],void 0===t[ne]&&(t[ne]=ee.generateId()),void 0===t[ie]&&(t[ie]=["RuntimeComponent"]),J(t,fe.metadef.schema,!1)?(a=K.RuntimeSchema.find({_name:r})).length?(i=O(t,a[0]),K.RuntimeSchema.update({_name:r},i),n=a[0]._id):n=K.RuntimeSchema.insert(t)[0]:Q.invalidSchema(t[te]),n}function C(e){var n=null,t=null,r="",i={},a=[];return n=JSON.parse(JSON.stringify(e)),r=n[te],void 0===n[ne]&&(n[ne]=ee.generateId()),J(n,fe.metadef.model,!1)?(a=K.RuntimeModel.find({_name:r})).length?(i=O(n,a[0]),K.RuntimeModel.update({_name:r},i),t=a[0]._id):t=K.RuntimeModel.insert(n)[0]:Q.invalidModel(n[te]),t}function I(e){var n=null,t=e.name;return J(e,fe.metadef.type)?n=K.RuntimeType.insert(e)[0]:Q.invalidTypeDefinition(t),n}function M(){q(),fe.metadef={schema:{_id:{type:"string",mandatory:!0},_name:{type:"string",mandatory:!0},_inherit:{type:["string"],mandatory:!1,default:["RuntimeComponent"]},_class:{type:"boolean",mandatory:!1},_core:{type:"boolean",mandatory:!1},_description:{type:"string",mandatory:!1}},model:{_id:{type:"string",mandatory:!0},_name:{type:"string",mandatory:!0},_inherit:{type:["string"],mandatory:!1},_class:{type:"boolean",mandatory:!1},_core:{type:"boolean",mandatory:!1},_description:{type:"string",mandatory:!1}},type:{_id:{type:"string",mandatory:!1},name:{type:"string",mandatory:!0},type:{type:"string",mandatory:!0},schema:{type:"object",mandatory:!1},value:{type:["any"],mandatory:!1},core:{type:"boolean",mandatory:!1},_description:{type:"string",mandatory:!1}}},f()}function q(){fe={metadef:{},inheritance:{},inheritanceTree:{},schemas:{},compiledSchemas:{},models:{},generatedModels:{},states:{},type:{}}}function P(){Q.modelCreationBegin(),i(),a(),d(),r(),m(),l(),y(),h(),g(),Q.modelCreationEnd()}function N(e,n){return $(e,n,de)}function A(e,n){return $(e,n,me)}function x(e,n){return $(e,n,le)}function T(e,n){return $(e,n,ce)}function D(e,n){return $(e,n,se)}function L(e,n){var t=!1,r=fe.generatedModels[n],i="";return r[e]&&(i=fe.type[r[e].type]),i&&i.schema&&(t=!0),t}function U(e,n){var t=!1,r=fe.generatedModels[n],i={};return r&&r[te]&&(r=fe.generatedModels[r[te]]),i=fe.states[r[te]],Array.isArray(i)&&(t=-1!==i.indexOf(e)),t}function E(e,n){function t(e,n){var t=!0,r=v(n),i=e;return""!==e&&null!==e&&(k(e,"string")&&(i=Z.get(e)),w(i)!==r&&"{}"!==JSON.stringify(i)&&(t=!1,Q.invalidType(e,n.replace("@","")))),t}var r=!0;switch(!0){case b(n):(r=p(e,n))||Q.invalidEnumType(e,n,fe.type[n].type),r&&(r=function(e,n){var t=fe.type[n],r=!0;return Array.isArray(t.value)&&-1===t.value.indexOf(e)&&(r=!1),!1===r&&Q.invalidEnumValue(e,n),r}(e,n));break;case _(n):r=t(e,n);break;default:r=function(e,n){var r=!0,i=0,a=0;switch(R(n)){case"string":r=k(e,n);break;case"array":for(a=e.length,i=0;i<a;i++)switch(!0){case b(n[0]):r=p(e[i],n[0]);break;case _(n[0]):r=t(e[i],n[0]);break;default:r=k(e[i],n[0])}}return r}(e,n)}return r}function F(e,n){var t=!0;return _(n.type)?(t=function(e,n){var t="";return"Function"===(t=e.constructor.name)&&(t=e.name),t===n}(Z.get(e),v(n.type))&&-1!==n.value.indexOf(e))||Q.invalidEnumValue(e,n.type):(t=k(e,n.type)&&-1!==n.value.indexOf(e))||Q.invalidEnumValue(e,n.name),t}function B(e,n){var t="",r=null,i=!0,a="",o="",s="",d=0,m=0;if(k(e,"object")){for(t in e){if(r=e[t],k(n[t],"undefined"))return Q.unknownProperty(t,n),!1;switch(a=n[t].type,!0){case _(a):i=function(){var n=!0,i=[];return o=v(a),o=e[o],b(o)?fe.type[o]?fe.type[o].schema?n=B(r,fe.type[o].schema):(n=k(r,fe.type[o].type),(i=fe.type[o].value)&&(n=S(r,i))):n=!1:n="array"===o?Array.isArray(r):_(o)?k(r,"object")||k(r,"string"):k(r,o),n||Q.invalidPropertyType(t,o,r),n}();break;default:i=function(){var e=!0;switch(s=R(a)){case"string":if(b(s))e=B(r,a);else if(!k(r,a)){Q.invalidPropertyType(t,a,r),e=!1;break}break;case"array":for(d=r.length,m=0;m<d;m++)if(b(a[0]))e=B(r[m],fe.type[a[0]].schema);else if(!k(r[m],a[0])){Q.invalidPropertyType(r[m],a[0],r[m]),e=!1;break}}return e}()}if(!i)break}for(t in n)if(r=n[t],!0===r.mandatory&&k(e[t],"undefined")&&void 0!==e[t]){Q.missingProperty(t),i=!1;break}}else i=!1,Q.invalidPropertyFormat(e);return i}function J(e,n,t,r){function i(e,n){var t=!0,r="";if(r=fe.type[n])switch(!0){case!k(r.schema,"undefined"):t=J(e,r.schema);break;case!k(r.value,"undefined"):t=F(e,r);break;default:t=E(e,r.type)}else t=!1;return t}var a="",o=null,s=!0,d=!0,m="",l="",c="",u=0,p=0;k(t,"undefined")&&(t=!0),k(r,"undefined")&&(t=!1);for(a in e)if(o=e[a],k(n[a],"undefined")&&"_core"!==a){if(t)return Q.unknownProperty(a,n),!1}else switch(m="_core"!==a?n[a].type:"boolean","_id"===a&&(m="string"),!0){case b(m):s=i(o,m);break;case _(m):s=function(n,t){var i=!0,o=null,s=!1;if(l=v(t),n&&n.id?(o=n,s=!0):o=Z.get(n),k(o,"undefined"))switch(!0){case k(n,"object")&&null!==n&&Object.keys(n).length>0:case k(n,"string")&&""!==n:Q.canNotYetValidate(n,l)}else X(o.constructor.name,l)?s&&r&&(e[a]=o.id()):(i=!1,Q.invalidType(n,l));return i}(o,m);break;default:s=function(e,n){var t=!0,o=null,s="";switch(c=R(n)){case"any":break;case"string":if(b(c))t=J(e,n);else if("array"===n){if("array"!==R(e)){Q.invalidPropertyType(a,n,e),t=!1;break}}else if("date"===n){if(o=new Date(e),!(t=!isNaN(o.getDate()))){Q.invalidPropertyType(a,n,e);break}}else if(R(e)!==n&&"any"!==R(e)){Q.invalidPropertyType(a,n,e),t=!1;break}break;case"array":if(Array.isArray(e)){for(u=e.length,s=n[0],p=0;p<u;p++)if(b(s))t=i(e[p],s);else if(_(s))if("string"===R(e[p]))if(Z.get(e[p])){if(!X(w(Z.get(e[p])),v(s))){Q.invalidClassName(JSON.stringify(e[p]),v(s),w(Z.get(e[p]))),t=!1;break}}else""!==e[p]&&Q.canNotYetValidate(e[p],v(s));else{if(!X(w(e[p]),v(s))){Q.invalidClassName(JSON.stringify(e[p]),v(s),w(e[p])),t=!1;break}r&&(e[p]=e[p].id())}else if(R(e[p])!==s&&"any"!==s){Q.invalidPropertyType(e[p],s,e[p]),t=!1;break}}else t=!1,Q.invalidType(e,"array");break;default:t=!1,Q.unknownType(e)}return t}(o,m)}for(a in n)d=(o=n[a]).mandatory,k(e[a],"undefined")&&!0===d&&(Q.missingProperty(a),s=!1);return s}function V(e,n){var t="",r=null,i=!0,a="";for(t in n)i=(r=n[t]).mandatory,a=r.default,k(e[t],"undefined")&&(!1!==i||k(a,"undefined")||(e[t]=a))}function G(e){var n=null;return fe.compiledSchemas[e]&&(n=fe.compiledSchemas[e]),n}function W(e){var n=null;return fe.generatedModels[e]&&(n=fe.generatedModels[e]),n}function z(e){var n=null;return fe.type[e]&&fe.type[e]&&(n=JSON.parse(JSON.stringify(fe.type[e]))),n}function Y(){return fe.metadef.schema}function H(e){return fe.inheritanceTree[e]?fe.inheritanceTree[e].slice():[]}function X(e,n){function t(e,n){var r=!1,i=[],a=0;if(0!==(i=H(e)).length)if(-1!==i.indexOf(n))r=!0;else for(a=0;a<0&&!(r=t(i[a],n));a++);return r}var r=!1,i=[],a=0,o=0;if(e!==n){if(i=H(e),o=i.length,0!==i.length)if(-1!==i.indexOf(n))r=!0;else for(a=0;a<o&&!(r=t(i[a],n));a++);}else r=!0;return r}var K=e("./db.js"),Q=e("./log.js"),Z=e("./component.js"),ee=(e("./workflow.js"),e("./helper.js")),ne="_id",te="_name",re="_description",ie="_inherit",ae="_class",oe="_core",se="method",de="event",me="property",le="link",ce="collection",ue=["property","collection","link","method","event"],pe=["boolean","string","number","object","function","array","date","any"],fe={metadef:{},inheritance:{},inheritanceTree:{},schemas:{},compiledSchemas:{},models:{},generatedModels:{},states:{},type:{}};t.init=M,t.clear=q,t.schema=j,t.model=C,t.type=I,t.create=P,t.getSchema=G,t.getModel=W,t.getMetaDef=Y,t.getParents=H,t.inheritFrom=X,t.isValidObject=J,t.prepareObject=V,t.isValidType=E,t.isValidEnum=F,t.isValidState=U,t.isEvent=N,t.isProperty=A,t.isLink=x,t.isCollection=T,t.isMethod=D,t.isStructure=L,t.getType=z},{"./component.js":3,"./db.js":4,"./helper.js":5,"./log.js":6,"./workflow.js":10}],8:[function(e,n,t){(function(t){"use strict";"undefined"==typeof window&&void 0!==t&&(t.require=e);var r=e("./db.js"),i=e("./component.js"),a=e("./metamodel.js"),o=e("../build/system/system.js"),s="",d="",m=null;e("./helper.js").polyfill(),a.init(),s=r.system(o.system),d=i.get(s),m=i.get("channel"),d.state("installed"),m.$systemInstalled(s),d.state("resolved"),m.$systemResolved(s),d.state("starting"),m.$systemStarted(s),d.main(),d.start(),d.state("active"),n.exports=i.get("runtime")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../build/system/system.js":1,"./component.js":3,"./db.js":4,"./helper.js":5,"./metamodel.js":7}],9:[function(e,n,t){"use strict";function r(e,n,t){s[e]={name:n,parameters:{data:t}},o.store.RuntimeState[e]={name:n,parameters:{data:t}}}function i(e){return s[e]}function a(){s={}}var o=e("./db.js"),s={};t.set=r,t.get=i,t.clear=a},{"./db.js":4}],10:[function(e,n,t){"use strict";function r(e){this.message=e,this.name="RuntimeError"}function i(e,n){var t=null,r=[],i=[],a=0,o=0;if(v.getModel(e)?t=v.getModel(e)[n]:S.unknownModel(e),t){if(r=t.params)for(a=r.length,o=0;o<a;o++)i.push(r[o].name)}else S.unknownMethod(e,n);return i}function a(e,n){var t=null,r=[],i=[],a=0,o=0,s=0,d=0;if(v.getModel(e)?t=v.getModel(e)[n]:S.unknownModel(e),t){if(r=t.params)for(a=r.length,o=0;o<a;o++)void 0!==r[o].mandatory&&!0!==r[o].mandatory||(s+=1),d+=1;i.push(s),i.push(d)}else S.unknownMethod(e,n);return i}function o(e,n,t){var r=null,i=[],a=[],o=0,s=0;if(r=v.getModel(e)[n]){if(i=r.params)for(o=i.length,s=0;s<o;s++)!1===i[s].mandatory&&void 0===t[s]?a.push(i[s].default):a.push(t[s])}else S.unknownMethod(e,n);return a}function s(e,n){var t=null,r=null;return v.getModel(e)?t=v.getModel(e)[n].result:S.unknownModel(e),t&&(r=t),r}function d(e,n){var t=null,r=[],i=[],a=0,o=0;if(v.getModel(e)?t=v.getModel(e)[n]:S.unknownModel(e),t){if(r=t.params)for(a=r.length,o=0;o<a;o++)i.push(r[o].type)}else S.unknownMethod(e,n);return i}function m(e){var n=(e=e||{}).component||null,t=e.methodName||"",r=null,i="",a=null,o=!0;if(r=void 0!==e.methodResult?e.methodResult:void 0,i="Function"===n.constructor.name?n.name:n.constructor.name,null!==(a=s(i,t)))switch(!0){case"any"===a:break;case"array"===a:Array.isArray(r)||(o=!1,S.invalidResultType(n.id(),n.constructor.name,t,a,null));break;default:typeof r!==a&&(o=!1,S.invalidResultType(n.id(),n.constructor.name,t,a,typeof r))}return o}function l(e,n,t){var r=_.getActions(e.id(),n),i=[],a=0,o=0,s=null;if(!r.length||t)if("Function"!==e.constructor.name)r=r.concat(l(b.get(e.constructor.name),n,t));else for(a=(i=v.getParents(e.name)).length,o=0;o<a&&(s=b.get(i[o]),s?r=r.concat(l(s,n,t)):S.unknownComponent(i[o],e.name),!r.length);o++);return r.length&&r.reverse(),r}function c(e,n,i,a,s){var d=null,m=[],l="",c=0,u=0;l="Function"===e.constructor.name?e.name:e.constructor.name,v.isProperty(n,l)||v.isLink(n,l)||v.isCollection(n,l)||(a=o(l,n,a));try{for(u=a.length,c=0;c<u;c++)m.push(a[c]);i.useCoreAPI&&(m.push(b),m.push(k),m.push(v),m.push(t),m.push(_),m.push(R),m.push(S)),s?setTimeout(i.action.bind.apply(i.action,[e].concat(m)),0):d=i.action.apply(e,m)}catch(t){if(t instanceof r)throw t;void 0===new Function?console.error("runtime: can not execute new Function() instruction in the current context."):(e&&e.error&&e.error({message:"error when trying to call the method '"+n+"' on component '"+e.id()+"'",error:t}),w.getRuntime()&&w.getRuntime().error({message:"error when trying to call the method '"+n+"' on component '"+e.id()+"'",error:t}),S.actionInvokeError(n,e.id(),e.constructor.name,t.message))}return d}function u(e,n,t){var r="",i=-1,o="",s="",d=[],m=0,l=[],c=!1,u=!1,p=!1,f=!1;switch(r=t.toString(),i=r.indexOf("{"),o=r.substring(0,i),s=o.split("(")[1].replace(")","").trim(),""===(d=s.split(","))[0]&&(d=[]),m=d.length,c=v.isProperty(n,e),u=v.isLink(n,e),p=v.isCollection(n,e),!0){case p:l=[2,2];break;case c:case u:l=[1,1];break;default:l=a(e,n)}return l[0]<=m&&m<=l[1]&&(f=!0),f}function p(e){var n=(e=e||{}).component||null,t=e.methodName||"",r=e.args||"",o=[],s=[],m=[],l="",c=r.length,u=0,p=null,f=!0,y=!1,h=!1,g=!1;switch(l="Function"===n.constructor.name?n.name:n.constructor.name,y=v.isProperty(t,l),h=v.isLink(t,l),g=v.isCollection(t,l),o=i(l,t),!0){case g:s=r&&r[1]&&"reset"===r[1]?[[v.getModel(l)[t].type[0]],"string"]:[v.getModel(l)[t].type[0],"string"],m=[2,2];break;case y:case h:s=[v.getModel(l)[t].type],m=[1,1];break;default:s=d(l,t),m=a(l,t)}for(void 0===c&&(c=1),(c<m[0]||m[1]<c)&&(f=!1,S.invalidParamNumber(n.id(),n.constructor.name,t)),u=0;u<c;u++)if(void 0===(p=r[u])){if(!(u<m[0]))continue;f=!1,S.invalidParamNumber(n.id(),n.constructor.name,t)}else v.isValidType(p,s[u])||(f=!1,S.invalidParamType(n.id(),n.constructor.name,t,o[u]));return f}function f(e,n){var t=!1,r=!1,i=!1,a=!1,o=[],s=null,d=null,m="",l=null;o=k.RuntimeBehavior.find({_id:e}),l=_.get(e),1===o.length&&(s=o[0],(d=b.get(s.component))&&(m="Function"===d.constructor.name?d.name:d.constructor.name,t=v.isEvent(s.state,m),r=v.isProperty(s.state,m),i=v.isLink(s.state,m),a=v.isCollection(s.state,m),(t||r||a||i)&&c(d,s.state,{useCoreAPI:s.useCoreAPI,action:l},n,!0)))}function y(e){(e=e||{}).component=e.component||"",e.state=e.state||"",e.data=e.data||[];var n=null,t=[],r=null,i=null,a=0,o=0,s=!1,d=!1,u=!1,f=!1,y=!1;if("destroy"===R.get(e.component)&&S.invalidUseOfComponent(e.component),(n=b.get(e.component))&&(s="Function"===n.constructor.name?n.name:n.constructor.name,y=v.isEvent(e.state,s),d=v.isProperty(e.state,s),u=v.isLink(e.state,s),f=v.isCollection(e.state,s),t=l(n,e.state,y)),t.length){if(p({component:n,methodName:e.state,args:e.data}))if(y||d||u||f){for(o=t.length,a=0;a<o;a++)r=t[a],c(n,e.state,r,e.data,!0);R.set(n.id(),e.state,e.data)}else r=t[0],i=c(n,e.state,r,e.data,!1),m({component:n,methodName:e.state,methodResult:i});return i}n&&(y||d||u||f)&&R.set(n.id(),e.state,e.data)}function h(e){if(void 0===(e=e||{}).error&&(e.error=!1),e.message=e.message||"",t.state=function(){},e.error)throw new r(e.message?"runtime has been stopped because "+e.message:"runtime has been stopped because of an unknown error");e.message?console.error("runtime: runtime has been stopped because "+e.message):console.error("runtime: runtime has been stopped")}function g(){t.state=y,S.workflowRestarted()}var v=e("./metamodel.js"),b=e("./component.js"),_=e("./behavior.js"),R=e("./state.js"),w=e("./helper.js"),S=e("./log.js"),k=e("./db.js");r.prototype=new Error,r.prototype.constructor=r,t.state=y,t.stop=h,t.restart=g,t.checkParams=p,t.validParamNumbers=u,t.action=f},{"./behavior.js":2,"./component.js":3,"./db.js":4,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9}]},{},[8])(8)});